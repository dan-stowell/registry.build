<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">libc_replacer</h1><a id="user-content-libc_replacer" class="anchor" aria-label="Permalink: libc_replacer" href="#libc_replacer"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Replace libc APIs with user-defined functions.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Description</h2><a id="user-content-description" class="anchor" aria-label="Permalink: Description" href="#description"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>libc_replacer</code> enables developers to replace standard libc APIs with user-defined functions, providing greater control over non-deterministic behaviors in applications.</p>
<p dir="auto">By substituting libc APIs with mock implementations, <code>libc_replacer</code> allows for more predictable and isolated testing environments. Supported libc APIs include:</p>
<ul dir="auto">
<li><a href="https://www.unix.com/man-page/linux/3/calloc/" rel="nofollow"><code>calloc</code></a></li>
<li><a href="https://www.unix.com/man-page/linux/3/clock/" rel="nofollow"><code>clock</code></a></li>
<li><a href="https://www.unix.com/man-page/linux/3/free/" rel="nofollow"><code>free</code></a></li>
<li><a href="https://www.unix.com/man-page/linux/3/malloc/" rel="nofollow"><code>malloc</code></a></li>
<li><a href="https://www.unix.com/man-page/linux/3/realloc/" rel="nofollow"><code>realloc</code></a></li>
<li><a href="https://www.unix.com/man-page/linux/2/time/" rel="nofollow"><code>time</code></a></li>
<li><a href="https://en.cppreference.com/w/c/chrono/timespec_get" rel="nofollow"><code>timespec_get</code></a></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Prerequisites</h2><a id="user-content-prerequisites" class="anchor" aria-label="Permalink: Prerequisites" href="#prerequisites"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To use <code>libc_replacer</code>, ensure your C/C++ toolchain meets the following requirements:</p>
<ul dir="auto">
<li><strong>C11 support</strong></li>
<li><strong>Full static linking</strong>: All libraries must be statically linked to the application.</li>
<li><strong>Symbol wrapping support</strong>: Your linker must support symbol wrapping (e.g., <code>--wrap</code> in <a href="https://www.unix.com/man-page/linux/1/ld/" rel="nofollow">GNU ld</a>).</li>
</ul>
<p dir="auto">Although <code>libc_replacer</code> can be used without <a href="https://bazel.build/" rel="nofollow">Bazel</a>, it is designed to integrate easily with it and includes dedicated Bazel rules to simplify usage. Bazel is therefore recommended for building and testing.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Headers for each target libc API are located under <code>libc_replacer/cc/{target}.h</code>. The library provides two main functions for each API:</p>
<ul dir="auto">
<li><code>libc_replacer_overwrite_{target}</code>: Overwrites the original libc function call with a specified function pointer, returning void.</li>
<li><code>libc_replacer_reset_{target}</code>: Restores the original libc function, returning void.</li>
</ul>
<p dir="auto">For usage examples, refer to the <a href="integration_test">integration tests</a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">C/C++ example</h3><a id="user-content-cc-example" class="anchor" aria-label="Permalink: C/C++ example" href="#cc-example"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="#include &lt;libc_replacer/cc/malloc.h&gt;
#include &lt;stdlib.h&gt;

static void *mock_malloc(size_t size) {
  (void)size;
  return NULL; // Always returns `NULL` to simulate allocation failure
}

int main(void) {
  libc_replacer_overwrite_malloc(mock_malloc);

  const size_t size_arg = 4;
  // `malloc` is now replaced by `mock_malloc`,
  // so `got` will always be `NULL` without heap allocation.
  const void *const got = malloc(size_arg);
  libc_replacer_reset_malloc();

  // After reset, `malloc` behaves normally again.
  void *const got_after_reset = malloc(size_arg);
  free(got_after_reset);
}"><pre><span class="pl-k">#include</span> <span class="pl-s">&lt;libc_replacer/cc/malloc.h&gt;</span>
<span class="pl-k">#include</span> <span class="pl-s">&lt;stdlib.h&gt;</span>

<span class="pl-k">static</span> <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-en">mock_malloc</span>(<span class="pl-smi">size_t</span> <span class="pl-s1">size</span>) {
  (<span class="pl-smi">void</span>)<span class="pl-s1">size</span>;
  <span class="pl-k">return</span> <span class="pl-c1">NULL</span>; <span class="pl-c">// Always returns `NULL` to simulate allocation failure</span>
}

<span class="pl-smi">int</span> <span class="pl-en">main</span>(<span class="pl-smi">void</span>) {
  <span class="pl-en">libc_replacer_overwrite_malloc</span>(<span class="pl-s1">mock_malloc</span>);

  <span class="pl-k">const</span> <span class="pl-smi">size_t</span> <span class="pl-s1">size_arg</span> <span class="pl-c1">=</span> <span class="pl-c1">4</span>;
  <span class="pl-c">// `malloc` is now replaced by `mock_malloc`,</span>
  <span class="pl-c">// so `got` will always be `NULL` without heap allocation.</span>
  <span class="pl-k">const</span> <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-k">const</span> <span class="pl-s1">got</span> <span class="pl-c1">=</span> <span class="pl-en">malloc</span>(<span class="pl-s1">size_arg</span>);
  <span class="pl-en">libc_replacer_reset_malloc</span>();

  <span class="pl-c">// After reset, `malloc` behaves normally again.</span>
  <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-k">const</span> <span class="pl-s1">got_after_reset</span> <span class="pl-c1">=</span> <span class="pl-en">malloc</span>(<span class="pl-s1">size_arg</span>);
  <span class="pl-en">free</span>(<span class="pl-s1">got_after_reset</span>);
}</pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Bazel integration</h3><a id="user-content-bazel-integration" class="anchor" aria-label="Permalink: Bazel integration" href="#bazel-integration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Load <code>libc_replacer</code> from the <a href="https://registry.bazel.build/modules/libc_replacer" rel="nofollow">Bazel Central Registry</a> to use it as a Bazel module.</p>
<p dir="auto">The module provides <code>cc_libc_replacer_binary</code> and <code>cc_libc_replacer_test</code>, which are similar to <code>cc_binary</code> and <code>cc_test</code>, with one additional required parameter: <code>libs_to_replace</code>. This parameter, a list of strings, specifies the names of libc APIs to replace.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
    &quot;@libc_replacer//:cc.bzl&quot;,
    &quot;cc_libc_replacer_binary&quot;,
    &quot;cc_libc_replacer_test&quot;,
)

# Define a binary target that replaces `malloc` with a user-defined function.
cc_libc_replacer_binary(
    name = &quot;your_binary&quot;,
    srcs = [&quot;your_binary_code.c&quot;],
    libs_to_replace = [&quot;malloc&quot;],  # Required: List of libc APIs to replace
)

# Define a test target that replaces `time` with a user-defined function.
cc_libc_replacer_test(
    name = &quot;your_test&quot;,
    timeout = &quot;short&quot;,
    srcs = [&quot;your_test_code.c&quot;],
    libs_to_replace = [&quot;time&quot;],  # Required: List of libc APIs to replace
)"><pre><span class="pl-en">load</span>(
    <span class="pl-s">"@libc_replacer//:cc.bzl"</span>,
    <span class="pl-s">"cc_libc_replacer_binary"</span>,
    <span class="pl-s">"cc_libc_replacer_test"</span>,
)

<span class="pl-c"># Define a binary target that replaces `malloc` with a user-defined function.</span>
<span class="pl-en">cc_libc_replacer_binary</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"your_binary"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"your_binary_code.c"</span>],
    <span class="pl-s1">libs_to_replace</span> <span class="pl-c1">=</span> [<span class="pl-s">"malloc"</span>],  <span class="pl-c"># Required: List of libc APIs to replace</span>
)

<span class="pl-c"># Define a test target that replaces `time` with a user-defined function.</span>
<span class="pl-en">cc_libc_replacer_test</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"your_test"</span>,
    <span class="pl-s1">timeout</span> <span class="pl-c1">=</span> <span class="pl-s">"short"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"your_test_code.c"</span>],
    <span class="pl-s1">libs_to_replace</span> <span class="pl-c1">=</span> [<span class="pl-s">"time"</span>],  <span class="pl-c"># Required: List of libc APIs to replace</span>
)</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Contributing</h2><a id="user-content-contributing" class="anchor" aria-label="Permalink: Contributing" href="#contributing"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Pull requests and issues are welcome! See <a href="DEVEL.md">DEVEL.md</a> for development documentation.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">CI status</h2><a id="user-content-ci-status" class="anchor" aria-label="Permalink: CI status" href="#ci-status"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://github.com/yuyawk/libc_replacer/actions/workflows/tests.yml"><img src="https://github.com/yuyawk/libc_replacer/actions/workflows/tests.yml/badge.svg" alt="Tests" style="max-width: 100%;"></a></p>
<p dir="auto"><a href="https://github.com/yuyawk/libc_replacer/actions/workflows/bazel-steward.yml"><img src="https://github.com/yuyawk/libc_replacer/actions/workflows/bazel-steward.yml/badge.svg" alt="Bazel Steward" style="max-width: 100%;"></a></p>
<p dir="auto"><a href="https://github.com/yuyawk/libc_replacer/actions/workflows/release.yml"><img src="https://github.com/yuyawk/libc_replacer/actions/workflows/release.yml/badge.svg" alt="Release" style="max-width: 100%;"></a></p>

</article></div>