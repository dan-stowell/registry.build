<div id="readme" class="rst" data-path="README.rst"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto"><em>kustomize</em> rules for Bazel</h1><a id="user-content-kustomize-rules-for-bazel" class="anchor" aria-label="Permalink: kustomize rules for Bazel" href="#kustomize-rules-for-bazel"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Integrate <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomize" rel="nofollow">the <em>kustomize</em> tool</a> into your Bazel projects to build Kubernetes-style manifests.</p>
<div id="user-content-contents" dir="auto">
<p dir="auto">Contents</p>
<ul dir="auto">
<li><a href="#overview" id="user-content-id4">Overview</a><ul dir="auto">
<li><a href="#simple-example" id="user-content-id5">Simple Example</a></li>
</ul>
</li>
<li><a href="#integrating-into-your-project" id="user-content-id6">Integrating Into Your Project</a></li>
<li><a href="#tool-versions" id="user-content-id7">Tool Versions</a></li>
<li><a href="#rules" id="user-content-id8">Rules</a><ul dir="auto">
<li><a href="#kustomization" id="user-content-id9">kustomization</a></li>
<li><a href="#kustomized-resources" id="user-content-id10">kustomized_resources</a></li>
</ul>
</li>
<li><a href="#id3" id="user-content-id11">Providers</a><ul dir="auto">
<li><a href="#kustomizationinfo" id="user-content-id12">KustomizationInfo</a></li>
</ul>
</li>
<li><a href="#difficulties" id="user-content-id13">Difficulties</a><ul dir="auto">
<li><a href="#bazel-s-sandbox-and-load-restrictors" id="user-content-id14">Bazel's Sandbox and Load Restrictors</a></li>
<li><a href="#downloading-helm-charts" id="user-content-id15">Downloading Helm Charts</a></li>
</ul>
</li>
</ul>
</div>
<hr>
<a name="user-content-overview"></a>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><a href="#id4">Overview</a></h2><a id="user-content-overview" class="anchor" aria-label="Permalink: Overview" href="#overview"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">These Bazel rules allow you to define <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization" rel="nofollow">kustomizations</a> within your project workspace and capture the output of <em>building</em> those kustomizations with <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomize" rel="nofollow">the <em>kustomize</em> tool</a>. Using <em>kustomize</em> within a Bazel project orchestrates both the preparation of the input files—for when static files won't do—and consumption of the resulting YAML document stream, situating <em>kustomize</em> as a transformer in the middle of that data flow.</p>
<p dir="auto"><em>kustomize</em> operates on the Kubernetes Resource Model (KRM), and most often comes into play just ahead of Kubernetes API clients like <em>kubectl</em>, sending the YAML document stream to the Kubernetes API to apply the <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#resource" rel="nofollow">resources</a> to the cluster. These rules do no include any such interaction with the Kubernetes API. Instead, they focus solely on emitting the resources defined by the <em>kustomization</em>.</p>
<a name="user-content-simple-example"></a>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><a href="#id5">Simple Example</a></h3><a id="user-content-simple-example" class="anchor" aria-label="Permalink: Simple Example" href="#simple-example"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Here we'll walk through a simple example to give a feel for how to use these Bazel rules.</p>
<p dir="auto">Assume you have a <em>kustomization</em> that defines a single Kubernetes <em>ConfigMap</em>, taking its data entries from both a file containing "environment variable"-style line-by-line definitions and some inline definitions in the <em>kustomization.yaml</em> file. First, the <em>kustomization.yaml</em> file:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

configMapGenerator:
- name: translations
  envs:
  - config-bindings
  literals:
  - HELLO=hola
  - GOODBYE=adios"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-s">kustomize.config.k8s.io/v1beta1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">Kustomization</span>

<span class="pl-ent">configMapGenerator</span>:
- <span class="pl-ent">name</span>: <span class="pl-s">translations</span>
  <span class="pl-ent">envs</span>:
  - <span class="pl-s">config-bindings</span>
  <span class="pl-ent">literals</span>:
  - <span class="pl-s">HELLO=hola</span>
  - <span class="pl-s">GOODBYE=adios</span></pre></div>
<p dir="auto">Note that the "envs" field references a sibling file named <em>config-bindings</em>, with content as follows:</p>
<pre>THANK_YOU=gracias
</pre>
<p dir="auto">If we run the <em>kustomize build</em> command against the directory containing these two files, it emits the following YAML document:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: v1
data:
  GOODBYE: adios
  HELLO: hola
  THANK_YOU: gracias
kind: ConfigMap
metadata:
  name: translations-74424tmdd8"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-c1">v1</span>
<span class="pl-ent">data</span>:
  <span class="pl-ent">GOODBYE</span>: <span class="pl-s">adios</span>
  <span class="pl-ent">HELLO</span>: <span class="pl-s">hola</span>
  <span class="pl-ent">THANK_YOU</span>: <span class="pl-s">gracias</span>
<span class="pl-ent">kind</span>: <span class="pl-s">ConfigMap</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">translations-74424tmdd8</span></pre></div>
<p dir="auto">Now, let's teach Bazel to produce the same document.</p>
<p dir="auto">By convention, we'll add a couple of Bazel targets to the <em>BUILD.bazel</em> file in the same directory. First, we define the <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization" rel="nofollow">kustomization</a> itself, indicating where the <em>kustomization</em> file sits and which other files it depends on. For this, we use the <a href="#kustomization">kustomization</a> rule.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
     &quot;@rules_kustomize//kustomize:kustomize.bzl&quot;,
     &quot;kustomization&quot;,
 )

 kustomization(
     name = &quot;base&quot;,
     srcs = [
         &quot;config-bindings&quot;,
     ],
 )"><pre><span class="pl-en">load</span>(
     <span class="pl-s">"@rules_kustomize//kustomize:kustomize.bzl"</span>,
     <span class="pl-s">"kustomization"</span>,
 )

 <span class="pl-en">kustomization</span>(
     <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"base"</span>,
     <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [
         <span class="pl-s">"config-bindings"</span>,
     ],
 )</pre></div>
<p dir="auto">By default, the <a href="#kustomization">kustomization</a> rule assumes the <em>kustomization</em> file is named <em>kustomization.yaml</em>, but you can also point it at other file names, such as the <em>kustomization.yml</em> or <em>kustomization</em> alternatives that the <em>kustomize</em> tool accepts.</p>
<p dir="auto">This "base" target we've defined doesn't produce any artifacts. It prepares the recipe for building artifacts, in the same way that a <em>kustomization</em>'s files are inert input for the <em>kustomize</em> tool. When we'd like to build the <em>kustomization</em> using particular options—as we would by invoking <em>kustomize build</em>—we define another target in a <em>BUILD.bazel</em> file. Here we'll add to the same Bazel package, this time using the <a href="#kustomized-resources">kustomized_resources</a> rule.</p>
<p dir="auto">When we tell Bazel to build this new "simple" target, it will invoke <em>kustomize build</em> and write the output to a file named <em>simple.yaml</em>. That's the default mapping from target name to output file name, but you can change it with the <a href="#kustomized-resources">kustomized_resources</a> rule's <kbd>result</kbd> attribute. Other Bazel targets can then demand this file as input, forcing Bazel to rebuild the file whenever—and only when—any of the input files change.</p>
<a name="user-content-integrating-into-your-project"></a>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><a href="#id6">Integrating Into Your Project</a></h2><a id="user-content-integrating-into-your-project" class="anchor" aria-label="Permalink: Integrating Into Your Project" href="#integrating-into-your-project"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In order to use these rules in your Bazel project, you must instruct Bazel to download the source and run the functions that make the rules available. Add the following to your project's <em>MODULE.bazel</em> file.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel_dep(name = &quot;rules_kustomize&quot;, version = &quot;0.3.10&quot;)"><pre><span class="pl-en">bazel_dep</span>(<span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_kustomize"</span>, <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"0.3.10"</span>)</pre></div>
<p dir="auto">This declaration registers a particular version of the <em>helm</em> and <em>kustomize</em> tools, respectively. By default, it registers <a href="#tool-versions">the latest version known to the rules</a>. You can specify a preferred version for each tool by supplying the known version slug (e.g. "v4.5.7") as an argument to the respective module extension's <code>download</code> tag.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel_dep(name = &quot;rules_kustomize&quot;, version = &quot;0.3.10&quot;)

kustomize = use_extension(&quot;@rules_kustomize//kustomize:extensions.bzl&quot;, &quot;kustomize&quot;)
kustomize.download(version = &quot;v5.3.0&quot;)
helm = use_extension(&quot;@rules_kustomize//kustomize:extensions.bzl&quot;, &quot;helm&quot;)
helm.download(version = &quot;v3.12.1&quot;)"><pre><span class="pl-en">bazel_dep</span>(<span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_kustomize"</span>, <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"0.3.10"</span>)

<span class="pl-s1">kustomize</span> <span class="pl-c1">=</span> <span class="pl-en">use_extension</span>(<span class="pl-s">"@rules_kustomize//kustomize:extensions.bzl"</span>, <span class="pl-s">"kustomize"</span>)
<span class="pl-s1">kustomize</span>.<span class="pl-c1">download</span>(<span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"v5.3.0"</span>)
<span class="pl-s1">helm</span> <span class="pl-c1">=</span> <span class="pl-en">use_extension</span>(<span class="pl-s">"@rules_kustomize//kustomize:extensions.bzl"</span>, <span class="pl-s">"helm"</span>)
<span class="pl-s1">helm</span>.<span class="pl-c1">download</span>(<span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"v3.12.1"</span>)</pre></div>
<p dir="auto">If any number of modules wind up specifying different version values for these tags, the latest version—per <em>Semantic Versioning</em> sorting—among the proposed candidate versions wins. If any of the tags also include the <code>tolerate_newer</code> attribute with a value of <code>False</code>, then no competing version newer than that tag's proposed version can win.</p>
<p dir="auto">With those calls in place, you're now ready to use the rules in your Bazel packages.</p>
<a name="user-content-tool-versions"></a>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><a href="#id7">Tool Versions</a></h2><a id="user-content-tool-versions" class="anchor" aria-label="Permalink: Tool Versions" href="#tool-versions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">At present, these rules can load the following versions of these tools:</p>
<ul dir="auto">
<li><em>kustomize</em><ul dir="auto">
<li><a href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv5.4.1">v5.4.0</a> (default)</li>
<li><a href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv5.4.0">v5.4.0</a></li>
<li><a href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv5.3.0">v5.3.0</a></li>
<li><a href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv5.2.1">v5.2.1</a></li>
<li><a href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv5.1.0">v5.1.0</a></li>
<li><a href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv5.0.3">v5.0.3</a></li>
<li><a href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv5.0.1">v5.0.1</a></li>
</ul>
</li>
<li><em>helm</em><ul dir="auto">
<li><a href="https://github.com/helm/helm/releases/tag/v3.13.1">v3.13.1</a> (default)</li>
<li><a href="https://github.com/helm/helm/releases/tag/v3.12.1">v3.12.1</a></li>
<li><a href="https://github.com/helm/helm/releases/tag/v3.11.3">v3.11.3</a></li>
<li><a href="https://github.com/helm/helm/releases/tag/v3.11.2">v3.11.2</a></li>
<li><a href="https://github.com/helm/helm/releases/tag/v3.11.0">v3.11.0</a></li>
</ul>
</li>
</ul>
<a name="user-content-rules"></a>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><a href="#id8">Rules</a></h2><a id="user-content-rules" class="anchor" aria-label="Permalink: Rules" href="#rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<a name="user-content-kustomization"></a>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><a href="#id9">kustomization</a></h3><a id="user-content-kustomization" class="anchor" aria-label="Permalink: kustomization" href="#kustomization"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This defines a <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization" rel="nofollow">kustomization</a> from a set of source files and other <a href="#kustomization">kustomizations</a>, intended for referencing from one or more dependent <a href="#kustomized-resources">kustomized_resources</a> targets.</p>
<a name="user-content-providers"></a>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">Providers</h4><a id="user-content-providers" class="anchor" aria-label="Permalink: Providers" href="#providers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="#kustomizationinfo">KustomizationInfo</a></li>
</ul>
<a name="user-content-attributes"></a>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">Attributes</h4><a id="user-content-attributes" class="anchor" aria-label="Permalink: Attributes" href="#attributes"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>





<tbody valign="top">
<tr><td><strong>Name</strong></td>
<td><strong>Type</strong></td>
<td><strong>Default value</strong></td>
</tr>
<tr><td><kbd>name</kbd></td>
<td><em>string</em></td>
<td><strong>mandatory value</strong></td>
</tr>
<tr><td colspan="3">A unique name for the <em>kustomization</em>. As there is usually only one such target defined  per Bazel
package (assuming that the target is in the same package as the <em>kustomization</em> file), a simple name
like "base" is fitting.</td>
</tr>
<tr><td><kbd>deps</kbd></td>
<td><em>label_list</em></td>
<td><code>[]</code></td>
</tr>
<tr><td colspan="3">The set of <a href="#kustomization">kustomizations</a> referenced as <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#resource" rel="nofollow">resources</a> by this <em>kustomization</em>.</td>
</tr>
<tr><td><kbd>file</kbd></td>
<td><em>label</em></td>
<td><code>kustomization.yaml</code></td>
</tr>
<tr><td colspan="3"><em>kustomization.yaml</em>, <em>kustomization.yml</em>, or <em>kustomization</em> file for this
<em>kustomization</em>.</td>
</tr>
<tr><td><kbd>requires_exec_functions</kbd></td>
<td><em>bool</em></td>
<td><code>False</code></td>
</tr>
<tr><td colspan="3"><p dir="auto">Whether this <em>kustomization</em> requires use of exec functions (raw executables) (per the
<code>--enable-exec</code> <em>kustomize</em> flag).</p>
<p dir="auto">Even if this <em>kustomization</em>'s top-level resources don't require such use but any of its base <em>kustomizations</em> do, this value is effectively <code>True</code>.</p>
</td>
</tr>
<tr><td><kbd>requires_helm</kbd></td>
<td><em>bool</em></td>
<td><code>False</code></td>
</tr>
<tr><td colspan="3"><p dir="auto">Whether this <em>kustomization</em> requires use of the Helm chart inflator generator (per the
<code>--enable-helm</code> <em>kustomize</em> flag).</p>
<p dir="auto">Even if this <em>kustomization</em>'s top-level resources don't require such use but any of its base <em>kustomizations</em> do, this value is effectively <code>True</code>.</p>
</td>
</tr>
<tr><td><kbd>requires_plugins</kbd></td>
<td><em>bool</em></td>
<td><code>False</code></td>
</tr>
<tr><td colspan="3"><p dir="auto">Whether this <em>kustomization</em> requires use of <em>kustomize</em> plugins (per the
<code>--enable-alpha-plugins</code> <em>kustomize</em> flag).</p>
<p dir="auto">Even if this <em>kustomization</em>'s top-level resources don't require such use but any of its base <em>kustomizations</em> do, this value is effectively <code>True</code>.</p>
</td>
</tr>
<tr><td><kbd>requires_starlark_functions</kbd></td>
<td><em>bool</em></td>
<td><code>False</code></td>
</tr>
<tr><td colspan="3"><p dir="auto">Whether this <em>kustomization</em> requires use of Starlark functions (per the <code>--enable-star</code>
<em>kustomize</em> flag).</p>
<p dir="auto">Even if this <em>kustomization</em>'s top-level resources don't require such use but any of its base <em>kustomizations</em> do, this value is effectively <code>True</code>.</p>
</td>
</tr>
<tr><td><kbd>srcs</kbd></td>
<td><em>label_list</em></td>
<td><code>[]</code></td>
</tr>
<tr><td colspan="3">Files referenced as <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#resource" rel="nofollow">resources</a> for this <em>kustomization</em>.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<a name="user-content-example"></a>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">Example</h4><a id="user-content-example" class="anchor" aria-label="Permalink: Example" href="#example"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="kustomization(
    name = &quot;overlay&quot;,
    deps = [
        # This target &quot;base:base&quot; is another kustomization.
        &quot;//apps/base&quot;
    ],
    # We can omit the &quot;file&quot; attribute because our kustomization
    # file is named &quot;kustomization.yaml,&quot; matching the default.
    srcs = [
        # This target &quot;charts:charts&quot; is a filegroup.
        &quot;//apps/base/charts&quot;,
        &quot;extras.yaml&quot;,
    ],
    requires_helm = True,
)"><pre><span class="pl-en">kustomization</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"overlay"</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [
        <span class="pl-c"># This target "base:base" is another kustomization.</span>
        <span class="pl-s">"//apps/base"</span>
    ],
    <span class="pl-c"># We can omit the "file" attribute because our kustomization</span>
    <span class="pl-c"># file is named "kustomization.yaml," matching the default.</span>
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [
        <span class="pl-c"># This target "charts:charts" is a filegroup.</span>
        <span class="pl-s">"//apps/base/charts"</span>,
        <span class="pl-s">"extras.yaml"</span>,
    ],
    <span class="pl-s1">requires_helm</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>,
)</pre></div>
<a name="user-content-kustomized-resources"></a>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><a href="#id10">kustomized_resources</a></h3><a id="user-content-kustomized_resources" class="anchor" aria-label="Permalink: kustomized_resources" href="#kustomized_resources"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This defines an invocation of the <em>kustomize build</em> command against a <em>kustomization</em> <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#target" rel="nofollow">target</a>, creating a resulting set of <em>resources</em> (collectively, a <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#variant" rel="nofollow">variant</a>).</p>
<p dir="auto">See the <a href="#difficulties">Difficulties</a> section below for considerations both with <em>kustomizations</em> that involve use of the <code>helmCharts</code> <em>Kustomization</em> (or <em>Component</em>) field and when executing Bazel actions on some computers.</p>
<a name="user-content-id1"></a>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">Attributes</h4><a id="user-content-attributes-1" class="anchor" aria-label="Permalink: Attributes" href="#attributes-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>





<tbody valign="top">
<tr><td><strong>Name</strong></td>
<td><strong>Type</strong></td>
<td><strong>Default value</strong></td>
</tr>
<tr><td><kbd>name</kbd></td>
<td><em>string</em></td>
<td><strong>mandatory value</strong></td>
</tr>
<tr><td colspan="3">A unique name for the <em>variant</em>.</td>
</tr>
<tr><td><kbd>env_bindings</kbd></td>
<td><em>string_dict</em></td>
<td><code>{}</code></td>
</tr>
<tr><td colspan="3"><p dir="auto">Names and values of environment variables to be used by functions (per the <code>--env</code>
<em>kustomize</em> flag).</p>
<p dir="auto">These bindings specify a value for each environment variable. To forward an exported environment variable's
through instead, use the <kbd>env_exports</kbd> attribute.</p>
</td>
</tr>
<tr><td><kbd>env_exports</kbd></td>
<td><em>string_list</em></td>
<td><code>[]</code></td>
</tr>
<tr><td colspan="3"><p dir="auto">Names of exported environment variables to be used by functions (per the <code>--env</code> <em>kustomize</em>
flag).</p>
<p dir="auto">These bindings forward each exported environment variable's value. To specify a value for each environment
variable instead, use the <kbd>env_bindings</kbd> attribute.</p>
</td>
</tr>
<tr><td><kbd>kustomization</kbd></td>
<td><em>label</em></td>
<td><strong>mandatory value</strong></td>
</tr>
<tr><td colspan="3"><p dir="auto">The <em>kustomization</em> to build.</p>
<p dir="auto">This may refer to a target using the <a href="#kustomization">kustomization</a> rule or another rule that yields a <a href="#kustomizationinfo">KustomizationInfo</a>
provider.</p>
</td>
</tr>
<tr><td><kbd>load_restrictor</kbd></td>
<td><em>string</em></td>
<td><code>RootOnly</code></td>
</tr>
<tr><td colspan="3"><p dir="auto">Control whether <em>kustomizations</em> may load files from outsider their root directory (per the
<code>--load-restrictor</code> :tool:kustomize flag). May be one of <code>None</code> or <code>RootOnly</code>.</p>
<p dir="auto">See the <a href="#difficulties">Difficulties</a> section for cases where you may need to set this value to <code>None</code> within
Bazel when you could normally get by with the <em>kustomize</em> tool's default behavior of preventing
<em>kustomizations</em> from loading files from outside their <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization-root" rel="nofollow">root</a>.</p>
</td>
</tr>
<tr><td><kbd>result</kbd></td>
<td><em>output</em></td>
<td><code>&lt;name&gt;.yaml</code></td>
</tr>
<tr><td colspan="3">The built result, as a YAML stream of KRM resources in separate documents (per the <code>--output</code>
<em>kustomize</em> flag).</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<a name="user-content-id2"></a>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">Example</h4><a id="user-content-example-1" class="anchor" aria-label="Permalink: Example" href="#example-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="kustomized_resources(
    name = &quot;production&quot;,
    env_bindings = {
        &quot;CLUSTER_NAME&quot;: &quot;prod1234&quot;,
        &quot;ENVIRONMENT&quot;: &quot;production&quot;,
    },
    kustomization = &quot;:overlay&quot;,
)"><pre><span class="pl-en">kustomized_resources</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"production"</span>,
    <span class="pl-s1">env_bindings</span> <span class="pl-c1">=</span> {
        <span class="pl-s">"CLUSTER_NAME"</span>: <span class="pl-s">"prod1234"</span>,
        <span class="pl-s">"ENVIRONMENT"</span>: <span class="pl-s">"production"</span>,
    },
    <span class="pl-s1">kustomization</span> <span class="pl-c1">=</span> <span class="pl-s">":overlay"</span>,
)</pre></div>
<a name="user-content-id3"></a>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><a href="#id11">Providers</a></h2><a id="user-content-providers-1" class="anchor" aria-label="Permalink: Providers" href="#providers-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<a name="user-content-kustomizationinfo"></a>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><a href="#id12">KustomizationInfo</a></h3><a id="user-content-kustomizationinfo" class="anchor" aria-label="Permalink: KustomizationInfo" href="#kustomizationinfo"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>KustomizationInfo</em> summarizes a <em>kustomization</em> <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization-root" rel="nofollow">root</a>, as provided by the <a href="#kustomization">kustomization</a> rule.</p>
<a name="user-content-fields"></a>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">Fields</h4><a id="user-content-fields" class="anchor" aria-label="Permalink: Fields" href="#fields"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>




<tbody valign="top">
<tr><td><strong>Name</strong></td>
<td><strong>Type</strong></td>
</tr>
<tr><td><code>requires_exec_functions</code></td>
<td><em>bool</em></td>
</tr>
<tr><td colspan="2">Whether this <em>kustomization</em> requires use of exec functions (raw executables) (per the
<code>--enable-exec</code> <em>kustomize</em> flag).</td>
</tr>
<tr><td><code>requires_helm</code></td>
<td><em>bool</em></td>
</tr>
<tr><td colspan="2">Whether this <em>kustomization</em> requires use of the Helm chart inflator generator (per the
<code>--enable-helm</code> <em>kustomize</em> flag).</td>
</tr>
<tr><td><code>requires_plugins</code></td>
<td><em>bool</em></td>
</tr>
<tr><td colspan="2">Whether this <em>kustomization</em> requires use of <em>kustomize</em> plugins (per the
<code>--enable-alpha-plugins</code> <em>kustomize</em> flag).</td>
</tr>
<tr><td><code>requires_starlark_functions</code></td>
<td><em>bool</em></td>
</tr>
<tr><td colspan="2">Whether this <em>kustomization</em> requires use of Starlark functions (per the
<code>--enable-star</code> <em>kustomize</em> flag).</td>
</tr>
<tr><td><code>target_file</code></td>
<td><em>string</em></td>
</tr>
<tr><td colspan="2">The top-level <em>kustomization</em> file defining this <em>kustomization</em>.</td>
</tr>
<tr><td><code>transitive_resources</code></td>
<td><em>depset of File</em></td>
</tr>
<tr><td colspan="2">The set of files (including other <em>kustomizations</em>) referenced by this
<em>kustomization</em>.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<a name="user-content-difficulties"></a>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><a href="#id13">Difficulties</a></h2><a id="user-content-difficulties" class="anchor" aria-label="Permalink: Difficulties" href="#difficulties"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">These rules attempt to make using <em>kustomize</em> with Bazel easier, but there are a few features of the tools that interact poorly, or at least surprisingly, even when they're individually doing their job as intended. We can work around each problem once we know better what to expect.</p>
<a name="user-content-bazel-s-sandbox-and-load-restrictors"></a>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><a href="#id14">Bazel's Sandbox and Load Restrictors</a></h3><a id="user-content-bazels-sandbox-and-load-restrictors" class="anchor" aria-label="Permalink: Bazel's Sandbox and Load Restrictors" href="#bazels-sandbox-and-load-restrictors"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>kustomize</em> prefers to load files only from the <em>kustomization</em> root directory—the one containing the <em>kustomization.yaml</em> file—or any of its subdirectories. The <em>kustomize build</em> subcommand runs with a <em>load restrictor</em> to enforce this restrictive policy. By default, the <code>--load-restrictor</code> flag uses the value <code>LoadRestrictionsRootOnly</code>. With that value in effect, <em>kustomize build</em> will refuse to read any files referenced by a <em>kustomization</em> that lie outside of the <em>kustomization</em> root directory tree, per <a href="https://kubectl.docs.kubernetes.io/faq/kustomize/#security-file-foo-is-not-in-or-below-bar" rel="nofollow">this FAQ entry</a>.</p>
<p dir="auto">Bazel can execute the actions for its <em>build</em> and <em>test</em> commands in a restricted environment called a <em>sandbox</em>, using a technique called <a href="https://docs.bazel.build/versions/master/sandboxing.html" rel="nofollow">sandboxing</a>. On some operating systems, Bazel uses symbolic links to make only some files available to programs it runs in its actions. These symbolic links point upward and outward to files that lie outside of the <em>kustomization</em> root in the sandbox. Even though the links are within the <em>kustomization</em> root, their target files are not. <em>kustomize</em> considers this to transgress its <code>LoadRestrictionsRootOnly</code> load restriction and blocks the attempt to load the referenced file.</p>
<p dir="auto">There are three ways around this problem:</p>
<ul dir="auto">
<li><p dir="auto">Relax <em>kustomize</em>'s load restrictor by passing <code>LoadRestrictionsNone</code> to its <code>--load-restrictor</code> flag, by way of specifying the value <code>None</code> for the <a href="#kustomized-resources">kustomized_resources</a> rule's <kbd>load_restrictor</kbd> attribute.</p>
</li>
<li><p dir="auto">Use a Bazel <a href="https://docs.bazel.build/versions/master/sandboxing.html" rel="nofollow">sandboxing</a> implementation that doesn't rely on symbolic links, such as its <a href="https://docs.bazel.build/versions/master/sandboxing.html#sandboxfs_" rel="nofollow">sandboxfs</a> FUSE file system. With the <em>sandboxfs</em> tool installed, pass the <code>--experimental_use_sandboxfs</code> <a href="https://docs.bazel.build/versions/master/command-line-reference.html#flag--experimental_use_sandboxfs" rel="nofollow">flag</a> to <em>bazel build</em>, <em>bazel test</em>, or <em>bazel run</em>.</p>
<p dir="auto"><strong>NB:</strong> As of Bazel version 7.0.0, per <a href="https://github.com/bazelbuild/bazel/commit/b6e2693f83a7ece37c902416de26a3807b541ceb">commit b6e2693f83a7ece37c902416de26a3807b541ceb</a>, the <code>--experimental_use_sandboxfs</code> flag is no longer available. Bazel no longer supports use of the <em>sandboxfs</em> tool. See <em>kustomize</em> <a href="https://github.com/kubernetes-sigs/kustomize/issues/5216" data-hovercard-type="issue" data-hovercard-url="/kubernetes-sigs/kustomize/issues/5216/hovercard">issue 5216</a> for an alternate proposed workaround, which is implemented but not merged.</p>
</li>
</ul>
<ul id="user-content-disable-sandboxing" dir="auto">
<li>Disable Bazel <a href="https://docs.bazel.build/versions/master/sandboxing.html" rel="nofollow">sandboxing</a> entirely by omitting <code>sandboxed</code> from the values supplied via its <code>--spawn_strategy</code> <a href="https://docs.bazel.build/versions/master/command-line-reference.html#flag--spawn_strategy" rel="nofollow">flag</a>. With sandboxing disabled, Bazel will present the input files to <em>kustomize</em> as regular files. So long as those files lie within the <em>kustomization</em> root, the <code>LoadRestrictionsRootOnly</code> load restrictor will not intervene.</li>
</ul>
<a name="user-content-downloading-helm-charts"></a>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><a href="#id15">Downloading Helm Charts</a></h3><a id="user-content-downloading-helm-charts" class="anchor" aria-label="Permalink: Downloading Helm Charts" href="#downloading-helm-charts"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <em>kustomize</em> tool can expand Helm charts using the <em>Kustomization</em> manifest's <code>helmCharts</code> <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/examples/chart.md">field</a>. If the Helm chart's source files are not available already locally, <em>kustomize</em> can fetch the chart archive and unpack within the directory specified in the <code>helmGlobals.chartHome</code> <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/examples/chart.md#build-the-base-and-the-variants">field</a>. By default, this <code>chartHome</code> field's value is <code>charts</code>, meaning that <em>kustomize</em> will download and expand chart archives in the <em>charts/&lt;chart name&gt;</em> directory within the <em>kustomization</em> root.</p>
<p dir="auto">Now, first, let's acknowledge that the <em>kustomize</em> maintainers do <strong>not</strong> recommend <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/examples/chart.md#but-its-not-really-about-performance">downloading Helm charts automatically</a>, nor <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/examples/chart.md#best-practice">even relying on Helm for repeated expansion at all</a>. The capability is there in <em>kustomize</em> today, though, so let's clarify how Bazel might interfere.</p>
<p dir="auto">What could go wrong? Consider:</p>
<ul dir="auto">
<li><p dir="auto">If Bazel <a href="https://docs.bazel.build/versions/master/sandboxing.html" rel="nofollow">sandboxing</a> is enabled, you can't have <em>kustomize</em> download and write files within the sandbox directory tree.</p>
<p dir="auto">Instead, you can set the <em>Kustomization</em> <code>helmGlobals.chartHome</code> field to a directory to which Bazel is allowed to write, such as <em>/tmp</em>. Alternately, you can <a href="#disable-sandboxing">disable sandboxing</a> entirely.</p>
</li>
<li><p dir="auto">If your <em>kustomization</em> directs <em>kustomize</em> to store Helm chart files outside of the <em>kustomization</em> root, or even just refers to such distant files, the default load restrictor will block <em>kustomize</em> from reading them.</p>
<p dir="auto">You must relax the default load restrictor by specifying the value <code>None</code> for the <a href="#kustomized-resources">kustomized_resources</a> rule's <kbd>load_restrictor</kbd> attribute.</p>
</li>
</ul>
<p dir="auto">Given that your chosen use of Bazel likely implies a preference for hermetic and repeatable builds, it's best to at least acquire and unpack the Helm chart archives beforehand, committing the resulting files for future use. Expanding the Helm chart as manifests outside of <em>kustomize</em> is even better, though it's then harder to include artifacts generated by other Bazel rules. Finding the right balance will take some experimentation.</p>

</article></div>