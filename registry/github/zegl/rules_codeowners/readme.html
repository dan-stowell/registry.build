<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">rules_codeowners</h1><a id="user-content-rules_codeowners" class="anchor" aria-label="Permalink: rules_codeowners" href="#rules_codeowners"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Use Bazel to create GitHub CODEOWNERS.</p>
<p dir="auto">CODEOWNERS on GitHub is flawed in the way that there can only be one CODEOWNERS file.</p>
<p dir="auto"><code>rules_codeowners</code> allows you to define the CODEOWNERS at all levels in the repo, and then generating the final CODEOWNERs file.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><em>See also: <a href="https://github.com/zegl/rules_codeowners/blob/master/README_DOCS.md">README_DOCS.md</a></em></p>
<p dir="auto">rules_codeowners is available on the <a href="https://registry.bazel.build/modules/rules_codeowners" rel="nofollow">Bazel Central Registry</a>:</p>
<p dir="auto"><strong>Add this to your <code>MODULE.bazel</code>:</strong></p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel_dep(name = &quot;rules_codeowners&quot;, version = &quot;0.2.1&quot;)"><pre><span class="pl-en">bazel_dep</span>(<span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_codeowners"</span>, <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"0.2.1"</span>)</pre></div>
<p dir="auto"><strong>... or if you're not using modules, add this to <code>WORKSPACE</code>:</strong></p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

RULES_CODEOWNERS_VERSION = &quot;de6749190dcc5209427799b1e9777f79ab623702&quot;
RULES_CODEOWNERS_SHA = &quot;9277d41fefe2eded54ab1d3eeaebbef9ad28713291373a635079868980c6ead0&quot;

http_archive(
    name = &quot;rules_codeowners&quot;,
    strip_prefix = &quot;rules_codeowners-%s&quot; % RULES_CODEOWNERS_VERSION,
    sha256 = RULES_CODEOWNERS_SHA,
    url = &quot;https://github.com/zegl/rules_codeowners/archive/%s.zip&quot; % RULES_CODEOWNERS_VERSION,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-c1">RULES_CODEOWNERS_VERSION</span> <span class="pl-c1">=</span> <span class="pl-s">"de6749190dcc5209427799b1e9777f79ab623702"</span>
<span class="pl-c1">RULES_CODEOWNERS_SHA</span> <span class="pl-c1">=</span> <span class="pl-s">"9277d41fefe2eded54ab1d3eeaebbef9ad28713291373a635079868980c6ead0"</span>

<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_codeowners"</span>,
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_codeowners-%s"</span> <span class="pl-c1">%</span> <span class="pl-c1">RULES_CODEOWNERS_VERSION</span>,
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-c1">RULES_CODEOWNERS_SHA</span>,
    <span class="pl-s1">url</span> <span class="pl-c1">=</span> <span class="pl-s">"https://github.com/zegl/rules_codeowners/archive/%s.zip"</span> <span class="pl-c1">%</span> <span class="pl-c1">RULES_CODEOWNERS_VERSION</span>,
)</pre></div>
<p dir="auto"><strong>In BUILD files:</strong></p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@rules_codeowners//tools:codeowners.bzl&quot;, &quot;codeowners&quot;, &quot;generate_codeowners&quot;)

# Define one or many codeowners, should be added at multiple levels in the repo
codeowners(
    name = &quot;team_rule&quot;,

    # Set either team or teams to assign the GitHub team ownership
    team = &quot;@org/foo&quot;,
    # teams = [&quot;@org/team1&quot;, &quot;@org/team2&quot;],

    visibility = [&quot;//visibility:public&quot;],

    # Optional rules below
    pattern = &quot;*.js&quot;, # Adds pattern to the end of the path if this rule label is
                      # //foo/bar:codeowner, this would create an entry for /foo/bar/*.js

    patterns = [&quot;*.js&quot;, &quot;*.ts&quot;] # Same as pattern, but generates multiple rows, one for each pattern.
                                # Only one of pattern and patterns can be set at the same time.
)

# The generate_codeowners rule ties together multiple codeowners (and generate_codeowners) rules, and
# generates the final CODEOWNERS file.
#
# A generate_codeowners can use another generate_codeowners in the `owners` list,
# to effectively delegate access to modify the CODOWNERS in a part of the code-tree.
generate_codeowners(
    name = &quot;generate_codeowners&quot;,
    owners = [
        &quot;:team_rule&quot;,
    ],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@rules_codeowners//tools:codeowners.bzl"</span>, <span class="pl-s">"codeowners"</span>, <span class="pl-s">"generate_codeowners"</span>)

<span class="pl-c"># Define one or many codeowners, should be added at multiple levels in the repo</span>
<span class="pl-en">codeowners</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"team_rule"</span>,

    <span class="pl-c"># Set either team or teams to assign the GitHub team ownership</span>
    <span class="pl-s1">team</span> <span class="pl-c1">=</span> <span class="pl-s">"@org/foo"</span>,
    <span class="pl-c"># teams = ["@org/team1", "@org/team2"],</span>

    <span class="pl-s1">visibility</span> <span class="pl-c1">=</span> [<span class="pl-s">"//visibility:public"</span>],

    <span class="pl-c"># Optional rules below</span>
    <span class="pl-s1">pattern</span> <span class="pl-c1">=</span> <span class="pl-s">"*.js"</span>, <span class="pl-c"># Adds pattern to the end of the path if this rule label is</span>
                      <span class="pl-c"># //foo/bar:codeowner, this would create an entry for /foo/bar/*.js</span>

    <span class="pl-s1">patterns</span> <span class="pl-c1">=</span> [<span class="pl-s">"*.js"</span>, <span class="pl-s">"*.ts"</span>] <span class="pl-c"># Same as pattern, but generates multiple rows, one for each pattern.</span>
                                <span class="pl-c"># Only one of pattern and patterns can be set at the same time.</span>
)

<span class="pl-c"># The generate_codeowners rule ties together multiple codeowners (and generate_codeowners) rules, and</span>
<span class="pl-c"># generates the final CODEOWNERS file.</span>
<span class="pl-c">#</span>
<span class="pl-c"># A generate_codeowners can use another generate_codeowners in the `owners` list,</span>
<span class="pl-c"># to effectively delegate access to modify the CODOWNERS in a part of the code-tree.</span>
<span class="pl-en">generate_codeowners</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"generate_codeowners"</span>,
    <span class="pl-s1">owners</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":team_rule"</span>,
    ],
)</pre></div>
<p dir="auto">The <code>generate_codeowners</code> rule (<code>//:generate_codeowners</code>), can be built with Bazel to create
the complete CODEOWNERS file, the generated file will be located at <code>bazel-bin/generate_codeowners.out</code> by default.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel build //:generate_codeowners"><pre>bazel build //:generate_codeowners</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Making sure that the CODEOWNERS is up to date</h2><a id="user-content-making-sure-that-the-codeowners-is-up-to-date" class="anchor" aria-label="Permalink: Making sure that the CODEOWNERS is up to date" href="#making-sure-that-the-codeowners-is-up-to-date"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">It's not possible for Bazel to output files to the workspace, but it <em>is</em> possible to compare the current CODEOWNERS
with the generated version, to remind you that it's out of date with a <code>sh_test</code>.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sh_test(
    name = &quot;validate_codeowoners_up_to_date&quot;,
    srcs = [&quot;@rules_codeowners//tools:diff.sh&quot;],
    args = [
        &quot;$(location :generate_codeowners.out)&quot;,
        &quot;$(location CODEOWNERS)&quot;,
    ],
    data = [
        &quot;CODEOWNERS&quot;,
        &quot;:generate_codeowners.out&quot;,
    ],
)"><pre><span class="pl-en">sh_test</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"validate_codeowoners_up_to_date"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"@rules_codeowners//tools:diff.sh"</span>],
    <span class="pl-s1">args</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"$(location :generate_codeowners.out)"</span>,
        <span class="pl-s">"$(location CODEOWNERS)"</span>,
    ],
    <span class="pl-s1">data</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"CODEOWNERS"</span>,
        <span class="pl-s">":generate_codeowners.out"</span>,
    ],
)</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Automation tip: Automatically populate the <code>generate_codeowners</code></h2><a id="user-content-automation-tip-automatically-populate-the-generate_codeowners" class="anchor" aria-label="Permalink: Automation tip: Automatically populate the generate_codeowners" href="#automation-tip-automatically-populate-the-generate_codeowners"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To automatically set all <code>codeowners</code> as owners in a <code>generate_codeowners</code>, the following script that utilizes <code>bazel query</code> and <a href="https://github.com/bazelbuild/buildtools/tree/master/buildozer"><code>buildozer</code></a> can be used.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="#!/usr/bin/env bash

# target to the generate_codeowners, eg &quot;//.github:gen_codeowners&quot;
readonly target=$1

readonly BAZEL=$(which bazel)
readonly BUILDOZER=$(which buildozer)

readonly new_owners=$(
    # Query for all codeowners() rules (anchor at the front to avoid match on generate_codeowners rule)
    $BAZEL query --output=label 'kind(&quot;^codeowners rule&quot;, //...)' |
    # Print the length of each label at the front of the line
    awk '{ print length, $0 }' |
    # Sort shortest-first, so that the root //:OWNERS ends up first in CODEOWNERS
    sort -n -s |
    # 43 label -&gt; &quot;label&quot;
    awk '{ print &quot;\x22&quot; $2 &quot;\x22&quot; }' |
    # comma-separated
    tr '\n' ','
)

readonly command=&quot;set owners [${new_owners}]|${target}&quot;

echo &quot;$command&quot; | $BUILDOZER -f -"><pre><span class="pl-c"><span class="pl-c">#!</span>/usr/bin/env bash</span>

<span class="pl-c"><span class="pl-c">#</span> target to the generate_codeowners, eg "//.github:gen_codeowners"</span>
<span class="pl-k">readonly</span> target=<span class="pl-smi">$1</span>

<span class="pl-k">readonly</span> BAZEL=<span class="pl-s"><span class="pl-pds">$(</span>which bazel<span class="pl-pds">)</span></span>
<span class="pl-k">readonly</span> BUILDOZER=<span class="pl-s"><span class="pl-pds">$(</span>which buildozer<span class="pl-pds">)</span></span>

<span class="pl-k">readonly</span> new_owners=<span class="pl-s"><span class="pl-pds">$(</span></span>
<span class="pl-s">    <span class="pl-c"><span class="pl-c">#</span> Query for all codeowners() rules (anchor at the front to avoid match on generate_codeowners rule)</span></span>
<span class="pl-s">    <span class="pl-smi">$BAZEL</span> query --output=label <span class="pl-s"><span class="pl-pds">'</span>kind("^codeowners rule", //...)<span class="pl-pds">'</span></span> <span class="pl-k">|</span></span>
<span class="pl-s">    <span class="pl-c"><span class="pl-c">#</span> Print the length of each label at the front of the line</span></span>
<span class="pl-s">    awk <span class="pl-s"><span class="pl-pds">'</span>{ print length, $0 }<span class="pl-pds">'</span></span> <span class="pl-k">|</span></span>
<span class="pl-s">    <span class="pl-c"><span class="pl-c">#</span> Sort shortest-first, so that the root //:OWNERS ends up first in CODEOWNERS</span></span>
<span class="pl-s">    sort -n -s <span class="pl-k">|</span></span>
<span class="pl-s">    <span class="pl-c"><span class="pl-c">#</span> 43 label -&gt; "label"</span></span>
<span class="pl-s">    awk <span class="pl-s"><span class="pl-pds">'</span>{ print "\x22" $2 "\x22" }<span class="pl-pds">'</span></span> <span class="pl-k">|</span></span>
<span class="pl-s">    <span class="pl-c"><span class="pl-c">#</span> comma-separated</span></span>
<span class="pl-s">    tr <span class="pl-s"><span class="pl-pds">'</span>\n<span class="pl-pds">'</span></span> <span class="pl-s"><span class="pl-pds">'</span>,<span class="pl-pds">'</span></span></span>
<span class="pl-s"><span class="pl-pds">)</span></span>

<span class="pl-k">readonly</span> command=<span class="pl-s"><span class="pl-pds">"</span>set owners [<span class="pl-smi">${new_owners}</span>]|<span class="pl-smi">${target}</span><span class="pl-pds">"</span></span>

<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$command</span><span class="pl-pds">"</span></span> <span class="pl-k">|</span> <span class="pl-smi">$BUILDOZER</span> -f -</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Automation tip: Verify that all codeowners are transiently depended on a <code>generate_codeowners</code></h2><a id="user-content-automation-tip-verify-that-all-codeowners-are-transiently-depended-on-a-generate_codeowners" class="anchor" aria-label="Permalink: Automation tip: Verify that all codeowners are transiently depended on a generate_codeowners" href="#automation-tip-verify-that-all-codeowners-are-transiently-depended-on-a-generate_codeowners"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To verify that all <code>codeowners</code> are targeted by a <code>generate_codeowners</code>, a script like the one below can be used.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="#!/usr/bin/env bash

# target to the generate_codeowners, eg &quot;//.github:gen_codeowners&quot;
readonly target=$1

readonly TEEFILE=$(mktemp)
readonly BAZEL=$(which bazel)

$BAZEL query &quot;kind(codeowners, //...) except deps(${target})&quot; 2&gt;&amp;1 | tee &quot;$TEEFILE&quot; | grep &quot;Empty results&quot;
EXIT=$?

if [ &quot;$EXIT&quot; -eq 1 ]; then
    cat &quot;$TEEFILE&quot;
    echo &quot;--&gt; All codeowners rules must be depended on by ${target}&quot;
    echo &quot;--&gt; Add the codeowners as a dependency, or delete the target&quot;
    exit 1
fi

exit 0"><pre><span class="pl-c"><span class="pl-c">#!</span>/usr/bin/env bash</span>

<span class="pl-c"><span class="pl-c">#</span> target to the generate_codeowners, eg "//.github:gen_codeowners"</span>
<span class="pl-k">readonly</span> target=<span class="pl-smi">$1</span>

<span class="pl-k">readonly</span> TEEFILE=<span class="pl-s"><span class="pl-pds">$(</span>mktemp<span class="pl-pds">)</span></span>
<span class="pl-k">readonly</span> BAZEL=<span class="pl-s"><span class="pl-pds">$(</span>which bazel<span class="pl-pds">)</span></span>

<span class="pl-smi">$BAZEL</span> query <span class="pl-s"><span class="pl-pds">"</span>kind(codeowners, //...) except deps(<span class="pl-smi">${target}</span>)<span class="pl-pds">"</span></span> <span class="pl-k">2&gt;&amp;1</span> <span class="pl-k">|</span> tee <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$TEEFILE</span><span class="pl-pds">"</span></span> <span class="pl-k">|</span> grep <span class="pl-s"><span class="pl-pds">"</span>Empty results<span class="pl-pds">"</span></span>
EXIT=<span class="pl-smi">$?</span>

<span class="pl-k">if</span> [ <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$EXIT</span><span class="pl-pds">"</span></span> <span class="pl-k">-eq</span> 1 ]<span class="pl-k">;</span> <span class="pl-k">then</span>
    cat <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$TEEFILE</span><span class="pl-pds">"</span></span>
    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>--&gt; All codeowners rules must be depended on by <span class="pl-smi">${target}</span><span class="pl-pds">"</span></span>
    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>--&gt; Add the codeowners as a dependency, or delete the target<span class="pl-pds">"</span></span>
    <span class="pl-c1">exit</span> 1
<span class="pl-k">fi</span>

<span class="pl-c1">exit</span> 0</pre></div>
</article></div>