<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">go-jsonnet</h1><a id="user-content-go-jsonnet" class="anchor" aria-label="Permalink: go-jsonnet" href="#go-jsonnet"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://godoc.org/github.com/google/go-jsonnet" rel="nofollow"><img src="https://camo.githubusercontent.com/bf51a0c6f637498e8bbb25986ba778dbd92448c84ded30988f4a22e79850d899/68747470733a2f2f676f646f632e6f72672f6769746875622e636f6d2f676f6f676c652f676f2d6a736f6e6e65743f7374617475732e706e67" alt="GoDoc Widget" data-canonical-src="https://godoc.org/github.com/google/go-jsonnet?status.png" style="max-width: 100%;"></a> <a href="https://travis-ci.org/google/go-jsonnet" rel="nofollow"><img src="https://camo.githubusercontent.com/701d2468ba809448aef4051c4192139fb4489d562a0cda276d474973320de1b7/68747470733a2f2f7472617669732d63692e6f72672f676f6f676c652f676f2d6a736f6e6e65742e7376673f6272616e63683d6d6173746572" alt="Travis Widget" data-canonical-src="https://travis-ci.org/google/go-jsonnet.svg?branch=master" style="max-width: 100%;"></a> <a href="https://coveralls.io/github/google/go-jsonnet?branch=master" rel="nofollow"><img src="https://camo.githubusercontent.com/562724826fbe098d10e66df64fe38033e989c6164189a6e1471246c4f2f84dd7/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f676f6f676c652f676f2d6a736f6e6e65742f62616467652e7376673f6272616e63683d6d6173746572" alt="Coverage Status Widget" data-canonical-src="https://coveralls.io/repos/github/google/go-jsonnet/badge.svg?branch=master" style="max-width: 100%;"></a></p>
<p dir="auto">This an implementation of <a href="http://jsonnet.org/" rel="nofollow">Jsonnet</a> in pure Go. It is a feature complete, production-ready implementation. It is compatible with the original <a href="https://github.com/google/jsonnet">Jsonnet C++ implementation</a>. Bindings to C and Python are available (but not battle-tested yet).</p>
<p dir="auto">This code is known to work on Go 1.23 and above. We recommend always using the newest stable release of Go.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Installation instructions</h2><a id="user-content-installation-instructions" class="anchor" aria-label="Permalink: Installation instructions" href="#installation-instructions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# Using `go get` to install binaries is deprecated.
# The version suffix is mandatory.
go install github.com/google/go-jsonnet/cmd/jsonnet@latest

# Or other tools in the 'cmd' directory
go install github.com/google/go-jsonnet/cmd/jsonnet-lint@latest"><pre><span class="pl-c"><span class="pl-c">#</span> Using `go get` to install binaries is deprecated.</span>
<span class="pl-c"><span class="pl-c">#</span> The version suffix is mandatory.</span>
go install github.com/google/go-jsonnet/cmd/jsonnet@latest

<span class="pl-c"><span class="pl-c">#</span> Or other tools in the 'cmd' directory</span>
go install github.com/google/go-jsonnet/cmd/jsonnet-lint@latest</pre></div>
<p dir="auto">It's also available on Homebrew:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="brew install go-jsonnet"><pre class="notranslate"><code>brew install go-jsonnet
</code></pre></div>
<p dir="auto"><code>jsonnetfmt</code> and <code>jsonnet-lint</code> are also available as <a href="https://github.com/pre-commit/pre-commit">pre-commit</a> hooks. Example <code>.pre-commit-config.yaml</code>:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="- repo: https://github.com/google/go-jsonnet
  rev: # ref you want to point at, e.g. v0.17.0
  hooks:
    - id: jsonnet-format
    - id: jsonnet-lint"><pre>- <span class="pl-ent">repo</span>: <span class="pl-s">https://github.com/google/go-jsonnet</span>
  <span class="pl-ent">rev</span>: <span class="pl-c"><span class="pl-c">#</span> ref you want to point at, e.g. v0.17.0</span>
  <span class="pl-ent">hooks</span>:
    - <span class="pl-ent">id</span>: <span class="pl-s">jsonnet-format</span>
    - <span class="pl-ent">id</span>: <span class="pl-s">jsonnet-lint</span></pre></div>
<p dir="auto">It can also be embedded in your own Go programs as a library:</p>
<div class="highlight highlight-source-go notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="package main

import (
	&quot;fmt&quot;
	&quot;log&quot;

	&quot;github.com/google/go-jsonnet&quot;
)

func main() {
	vm := jsonnet.MakeVM()

	snippet := `{
		person1: {
		    name: &quot;Alice&quot;,
		    welcome: &quot;Hello &quot; + self.name + &quot;!&quot;,
		},
		person2: self.person1 { name: &quot;Bob&quot; },
	}`

	jsonStr, err := vm.EvaluateAnonymousSnippet(&quot;example1.jsonnet&quot;, snippet)
	if err != nil {
		log.Fatal(err)
	}

	fmt.Println(jsonStr)
	/*
	   {
	     &quot;person1&quot;: {
	         &quot;name&quot;: &quot;Alice&quot;,
	         &quot;welcome&quot;: &quot;Hello Alice!&quot;
	     },
	     &quot;person2&quot;: {
	         &quot;name&quot;: &quot;Bob&quot;,
	         &quot;welcome&quot;: &quot;Hello Bob!&quot;
	     }
	   }
	*/
}"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>

	<span class="pl-s">"github.com/google/go-jsonnet"</span>
)

<span class="pl-k">func</span> <span class="pl-s1">main</span>() {
	<span class="pl-s1">vm</span> <span class="pl-c1">:=</span> <span class="pl-s1">jsonnet</span>.<span class="pl-c1">MakeVM</span>()

	<span class="pl-s1">snippet</span> <span class="pl-c1">:=</span> <span class="pl-s">`{</span>
<span class="pl-s">		person1: {</span>
<span class="pl-s">		    name: "Alice",</span>
<span class="pl-s">		    welcome: "Hello " + self.name + "!",</span>
<span class="pl-s">		},</span>
<span class="pl-s">		person2: self.person1 { name: "Bob" },</span>
<span class="pl-s">	}`</span>

	<span class="pl-s1">jsonStr</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">vm</span>.<span class="pl-c1">EvaluateAnonymousSnippet</span>(<span class="pl-s">"example1.jsonnet"</span>, <span class="pl-s1">snippet</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-c1">Fatal</span>(<span class="pl-s1">err</span>)
	}

	<span class="pl-s1">fmt</span>.<span class="pl-c1">Println</span>(<span class="pl-s1">jsonStr</span>)
	<span class="pl-c">/*</span>
<span class="pl-c">	   {</span>
<span class="pl-c">	     "person1": {</span>
<span class="pl-c">	         "name": "Alice",</span>
<span class="pl-c">	         "welcome": "Hello Alice!"</span>
<span class="pl-c">	     },</span>
<span class="pl-c">	     "person2": {</span>
<span class="pl-c">	         "name": "Bob",</span>
<span class="pl-c">	         "welcome": "Hello Bob!"</span>
<span class="pl-c">	     }</span>
<span class="pl-c">	   }</span>
<span class="pl-c">	*/</span>
}</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Build instructions (go 1.23+)</h2><a id="user-content-build-instructions-go-123" class="anchor" aria-label="Permalink: Build instructions (go 1.23+)" href="#build-instructions-go-123"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="git clone git@github.com:google/go-jsonnet.git
cd go-jsonnet
go build ./cmd/jsonnet
go build ./cmd/jsonnetfmt
go build ./cmd/jsonnet-deps"><pre>git clone git@github.com:google/go-jsonnet.git
<span class="pl-c1">cd</span> go-jsonnet
go build ./cmd/jsonnet
go build ./cmd/jsonnetfmt
go build ./cmd/jsonnet-deps</pre></div>
<p dir="auto">To build with <a href="https://bazel.build/" rel="nofollow">Bazel</a> instead:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="git clone git@github.com:google/go-jsonnet.git
cd go-jsonnet
git submodule init
git submodule update
bazel build //cmd/jsonnet
bazel build //cmd/jsonnetfmt
bazel build //cmd/jsonnet-deps"><pre>git clone git@github.com:google/go-jsonnet.git
<span class="pl-c1">cd</span> go-jsonnet
git submodule init
git submodule update
bazel build //cmd/jsonnet
bazel build //cmd/jsonnetfmt
bazel build //cmd/jsonnet-deps</pre></div>
<p dir="auto">The resulting <em>jsonnet</em> program will then be available at a platform-specific path, such as <em>bazel-bin/cmd/jsonnet/darwin_amd64_stripped/jsonnet</em> for macOS.</p>
<p dir="auto">Bazel also accommodates cross-compiling the program. To build the <em>jsonnet</em> program for various popular platforms, run the following commands:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Target platform</th>
<th>Build command</th>
</tr>
</thead>
<tbody>
<tr>
<td>Current host</td>
<td><em>bazel build //cmd/jsonnet</em></td>
</tr>
<tr>
<td>Linux</td>
<td><em>bazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //cmd/jsonnet</em></td>
</tr>
<tr>
<td>macOS</td>
<td><em>bazel build --platforms=@io_bazel_rules_go//go/toolchain:darwin_amd64 //cmd/jsonnet</em></td>
</tr>
<tr>
<td>Windows</td>
<td><em>bazel build --platforms=@io_bazel_rules_go//go/toolchain:windows_amd64 //cmd/jsonnet</em></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">For additional target platform names, see the per-Go release definitions <a href="https://github.com/bazelbuild/rules_go/blob/master/go/private/sdk_list.bzl#L21-L31">here</a> in the <em>rules_go</em> Bazel package.</p>
<p dir="auto">Additionally if any files were moved around, see the section <a href="#keeping-the-bazel-files-up-to-date">Keeping the Bazel files up to date</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Building libjsonnet.wasm</h2><a id="user-content-building-libjsonnetwasm" class="anchor" aria-label="Permalink: Building libjsonnet.wasm" href="#building-libjsonnetwasm"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <a href="https://webassembly.org/" rel="nofollow">WASM</a> build can be used to embed go-jsonnet for use (client side) in the web browser. This is used for the live code snippets on <a href="https://jsonnet.org/" rel="nofollow">https://jsonnet.org/</a></p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="GOOS=js GOARCH=wasm go build -o libjsonnet.wasm ./cmd/wasm "><pre>GOOS=js GOARCH=wasm go build -o libjsonnet.wasm ./cmd/wasm </pre></div>
<p dir="auto">Or if using bazel:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bazel build //cmd/wasm:libjsonnet.wasm"><pre class="notranslate"><code>bazel build //cmd/wasm:libjsonnet.wasm
</code></pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Running tests</h2><a id="user-content-running-tests" class="anchor" aria-label="Permalink: Running tests" href="#running-tests"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="./tests.sh  # Also runs `go test ./...`"><pre>./tests.sh  <span class="pl-c"><span class="pl-c">#</span> Also runs `go test ./...`</span></pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Running Benchmarks</h2><a id="user-content-running-benchmarks" class="anchor" aria-label="Permalink: Running Benchmarks" href="#running-benchmarks"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Method 1</h3><a id="user-content-method-1" class="anchor" aria-label="Permalink: Method 1" href="#method-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="go get golang.org/x/tools/cmd/benchcmp"><pre>go get golang.org/x/tools/cmd/benchcmp</pre></div>
<ol dir="auto">
<li>Make sure you build a jsonnet binary <em>prior</em> to making changes.</li>
</ol>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="go build -o jsonnet-old ./cmd/jsonnet"><pre>go build -o jsonnet-old ./cmd/jsonnet</pre></div>
<ol start="2" dir="auto">
<li>Make changes (iterate as needed), and rebuild new binary</li>
</ol>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="go build ./cmd/jsonnet"><pre>go build ./cmd/jsonnet</pre></div>
<ol start="3" dir="auto">
<li>Run benchmark:</li>
</ol>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# e.g. ./benchmark.sh Builtin
./benchmark.sh &lt;TestNameFilter&gt;"><pre><span class="pl-c"><span class="pl-c">#</span> e.g. ./benchmark.sh Builtin</span>
./benchmark.sh <span class="pl-k">&lt;</span>TestNameFilter<span class="pl-k">&gt;</span></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Method 2</h3><a id="user-content-method-2" class="anchor" aria-label="Permalink: Method 2" href="#method-2"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ol dir="auto">
<li>get <code>benchcmp</code></li>
</ol>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="go get golang.org/x/tools/cmd/benchcmp"><pre>go get golang.org/x/tools/cmd/benchcmp</pre></div>
<ol start="2" dir="auto">
<li>Make sure you build a jsonnet binary <em>prior</em> to making changes.</li>
</ol>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="make build-old"><pre>make build-old</pre></div>
<ol start="3" dir="auto">
<li>iterate with (which will also automatically rebuild the new binary <code>./jsonnet</code>)</li>
</ol>
<p dir="auto"><em>replace the FILTER with the name of the test you are working on</em></p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="FILTER=Builtin_manifestJsonEx make benchmark"><pre>FILTER=Builtin_manifestJsonEx make benchmark</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Update cpp-jsonnet sub-repo</h2><a id="user-content-update-cpp-jsonnet-sub-repo" class="anchor" aria-label="Permalink: Update cpp-jsonnet sub-repo" href="#update-cpp-jsonnet-sub-repo"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This repo depends on <a href="https://github.com/google/jsonnet">the original Jsonnet repo</a>. Shared parts include the standard library, headers files for C API and some tests.</p>
<p dir="auto">You can update the submodule and regenerate dependent files with one command:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="./update_cpp_jsonnet.sh"><pre class="notranslate"><code>./update_cpp_jsonnet.sh
</code></pre></div>
<p dir="auto">Note: It needs to be run from repo root.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Updating and modifying the standard library</h2><a id="user-content-updating-and-modifying-the-standard-library" class="anchor" aria-label="Permalink: Updating and modifying the standard library" href="#updating-and-modifying-the-standard-library"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Standard library source code is kept in <code>cpp-jsonnet</code> submodule, because it is shared with <a href="https://github.com/google/jsonnet">Jsonnet C++
implementation</a>.</p>
<p dir="auto">For performance reasons we perform preprocessing on the standard library, so for the changes to be visible, regeneration is necessary:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="go run cmd/dumpstdlibast/dumpstdlibast.go cpp-jsonnet/stdlib/std.jsonnet &gt; astgen/stdast.go"><pre>go run cmd/dumpstdlibast/dumpstdlibast.go cpp-jsonnet/stdlib/std.jsonnet <span class="pl-k">&gt;</span> astgen/stdast.go</pre></div>
<p dir="auto">**The</p>
<p dir="auto">The above command creates the <em>astgen/stdast.go</em> file which puts the desugared standard library into the right data structures, which lets us avoid the parsing overhead during execution. Note that this step is not necessary to perform manually when building with Bazel; the Bazel target regenerates the <em>astgen/stdast.go</em> (writing it into Bazel's build sandbox directory tree) file when necessary.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Keeping the Bazel files up to date</h2><a id="user-content-keeping-the-bazel-files-up-to-date" class="anchor" aria-label="Permalink: Keeping the Bazel files up to date" href="#keeping-the-bazel-files-up-to-date"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Note that we maintain the Go-related Bazel targets with <a href="https://github.com/bazelbuild/bazel-gazelle">the Gazelle tool</a>. The Go module (<em>go.mod</em> in the root directory) remains the primary source of truth. Gazelle analyzes both that file and the rest of the Go files in the repository to create and adjust appropriate Bazel targets for building Go packages and executable programs.</p>
<p dir="auto">After changing any dependencies within the files covered by this Go module, it is helpful to run <em>go mod tidy</em> to ensure that the module declarations match the state of the Go source code. In order to synchronize the Bazel rules with material changes to the Go module, run the following command to invoke <a href="https://github.com/bazelbuild/bazel-gazelle#update-repos">Gazelle's <code>update-repos</code> command</a>:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=bazel/deps.bzl%jsonnet_go_dependencies"><pre>bazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=bazel/deps.bzl%jsonnet_go_dependencies</pre></div>
<p dir="auto">Similarly, after adding or removing Go source files, it may be necessary to synchronize the Bazel rules by running the following command:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel run //:gazelle"><pre>bazel run //:gazelle</pre></div>
</article></div>