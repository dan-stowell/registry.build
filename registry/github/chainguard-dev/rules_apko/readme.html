<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Bazel rules for apko</h1><a id="user-content-bazel-rules-for-apko" class="anchor" aria-label="Permalink: Bazel rules for apko" href="#bazel-rules-for-apko"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Wraps the <a href="https://github.com/chainguard-dev/apko">https://github.com/chainguard-dev/apko</a> tool for use under Bazel.</p>
<p dir="auto">Need help? This ruleset has support provided by <a href="https://aspect.dev" rel="nofollow">https://aspect.dev</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Installation</h2><a id="user-content-installation" class="anchor" aria-label="Permalink: Installation" href="#installation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Follow instructions in the release notes from the release you wish to use.
Be sure to follow the "Initial Setup" instructions as well.
<a href="https://github.com/chainguard-dev/rules_apko/releases">https://github.com/chainguard-dev/rules_apko/releases</a></p>
<p dir="auto">To use a commit rather than a release, you can point at any SHA of the repo,
using the GitHub-provided source archive like
`<a href="https://github.com/chainguard-dev/rules_apko/archive/abc123.tar.gz%60%60">https://github.com/chainguard-dev/rules_apko/archive/abc123.tar.gz``</a></p>
<div class="markdown-alert markdown-alert-note" dir="auto"><p class="markdown-alert-title" dir="auto"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p dir="auto">Note that GitHub source archives don't have a strong guarantee on the sha256 stability.
See <a href="https://github.blog/2023-02-21-update-on-the-future-stability-of-source-code-archives-and-hashes/" rel="nofollow">https://github.blog/2023-02-21-update-on-the-future-stability-of-source-code-archives-and-hashes/</a></p>
</div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Apko usage begins with an <code>apko.yaml</code> configuration file. The <code>apko lock</code> tool will create a corresponding
<code>apko.lock.json</code> file, and this is where Bazel will read to fetch external content.
Assuming <code>rules_apko</code> is already loaded in your <code>MODULE.bazel</code> or <code>WORKSPACE</code> file one can call:
<code>bazel run @rules_apko//apko -- lock ./apko.yaml</code> to lock the dependencies and generate <code>apko.lock.json</code> file.</p>
<p dir="auto">Then you import these base layers into Bazel:</p>
<ul dir="auto">
<li>With Bazel 6 and [bzlmod], call <code>apk.translate_lock</code> in <code>MODULE.bazel</code></li>
<li>Otherwise, call <code>translate_apko_lock</code> in <code>WORKSPACE</code></li>
</ul>
<p dir="auto">Now you can use the <code>apko_image</code> rule to build the image, producing an OCI format output.
As long as the apko <code>.yaml</code> file is in the same directory as the <code>apko_image</code> you can periodically refresh the
<code>apko.lock.json</code> file by just calling: <code>bazel run path/to/image.lock</code>.
Alternatively you can call <code>apko lock path/to/apko.yaml</code> or <code>bazel run @rules_apko//apko lock path/to/apko.yaml</code>
to regenerate the <code>apko.lock.json</code> file manually.
To resolve all the files in the repository, such a <a href="./examples/lock.sh">snippet</a> can be useful.</p>
<p dir="auto">Finally, we recommend using <a href="https://github.com/bazel-contrib/rules_oci">https://github.com/bazel-contrib/rules_oci</a> as the next step in your Bazel build
to add application code from your repo as the next layers of the image.</p>
<p dir="auto">See the examples folder in this repository, which relies on base layers declared in <code>/MODULE.bazel</code>.</p>
<p dir="auto">Also see the <code>e2e</code> folder in this repository, where we declare our end-to-end test.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Public API</h2><a id="user-content-public-api" class="anchor" aria-label="Permalink: Public API" href="#public-api"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="./docs/translate_lock.md">translate_lock</a> Repository rules for translating <code>apko.lock.json</code></li>
<li><a href="./docs/rules.md">rules</a> Build OCI images from APK packages directly without <code>Dockerfile</code></li>
</ul>
</article></div>