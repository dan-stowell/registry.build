<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Ra: A Raft Implementation for Erlang and Elixir</h1><a id="user-content-ra-a-raft-implementation-for-erlang-and-elixir" class="anchor" aria-label="Permalink: Ra: A Raft Implementation for Erlang and Elixir" href="#ra-a-raft-implementation-for-erlang-and-elixir"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://hex.pm/packages/ra/" rel="nofollow"><img src="https://camo.githubusercontent.com/5ec322bf7b40cf828b32e3d4192e326c9e676f03c160899b4f5f9723607ace08/68747470733a2f2f696d672e736869656c64732e696f2f686578706d2f762f7261" alt="Hex.pm" data-canonical-src="https://img.shields.io/hexpm/v/ra" style="max-width: 100%;"></a>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/rabbitmq/ra/actions/workflows/erlang.yml/badge.svg"><img src="https://github.com/rabbitmq/ra/actions/workflows/erlang.yml/badge.svg" alt="Actions" style="max-width: 100%;"></a></p>
<p dir="auto">Ra is a <a href="https://raft.github.io/" rel="nofollow">Raft</a> implementation
by Team RabbitMQ. It is not tied to RabbitMQ and can be used in any Erlang or Elixir
project. It is, however, heavily inspired by and geared towards RabbitMQ needs.</p>
<p dir="auto">Ra (by virtue of being a Raft implementation) is a library that allows users to implement <a href="https://en.wikipedia.org/wiki/State_machine_replication" rel="nofollow">persistent, fault-tolerant and replicated state machines</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Project Maturity</h2><a id="user-content-project-maturity" class="anchor" aria-label="Permalink: Project Maturity" href="#project-maturity"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This library has been extensively tested and is suitable for production use.
This means the primary APIs (<code>ra</code>, <code>ra_machine</code> modules) and on disk formats
will be backwards-compatible going forwards in line with Semantic Versioning.
Care has been taken to version all on-disk data formats to enable frictionless
future upgrades.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Status</h3><a id="user-content-status" class="anchor" aria-label="Permalink: Status" href="#status"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The following Raft features are implemented:</p>
<ul dir="auto">
<li>Leader election</li>
<li>Log replication</li>
<li>Cluster membership changes: one server (member) at a time</li>
<li>Log compaction (with limitations and RabbitMQ-specific extensions)</li>
<li>Snapshot installation</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Safety Verification</h3><a id="user-content-safety-verification" class="anchor" aria-label="Permalink: Safety Verification" href="#safety-verification"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Ra is <a href="https://github.com/rabbitmq/ra-kv-store#jepsen-test">continuously tested</a> with the <a href="https://github.com/jepsen-io/jepsen">Jepsen</a>
distributed system verification framework.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Supported Erlang/OTP Versions</h2><a id="user-content-supported-erlangotp-versions" class="anchor" aria-label="Permalink: Supported Erlang/OTP Versions" href="#supported-erlangotp-versions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Ra supports the following Erlang/OTP versions:</p>
<ul dir="auto">
<li><code>27.x</code></li>
<li><code>26.x</code></li>
</ul>
<p dir="auto">Modern Erlang releases provide <a href="https://www.erlang.org/blog/otp-22-highlights/#fragmented-distribution-messages" rel="nofollow">distribution traffic fragmentation</a>
which algorithms such as Raft significantly benefit from.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Design Goals</h2><a id="user-content-design-goals" class="anchor" aria-label="Permalink: Design Goals" href="#design-goals"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>Low footprint: use as few resources as possible, avoid process tree explosion</li>
<li>Able to run thousands of <code>ra</code> clusters within an Erlang node</li>
<li>Provide adequate performance for use as a basis for a distributed data service</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Use Cases</h2><a id="user-content-use-cases" class="anchor" aria-label="Permalink: Use Cases" href="#use-cases"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This library was primarily developed as the foundation of a replication layer for
<a href="https://rabbitmq.com/quorum-queues.html" rel="nofollow">quorum queues</a> in RabbitMQ, and today
also powers <a href="https://rabbitmq.com/streams.html" rel="nofollow">RabbitMQ streams</a> and <a href="https://github.com/rabbitmq/khepri">Khepri</a>.</p>
<p dir="auto">The design it aims to replace uses
a variant of <a href="https://www.cs.cornell.edu/home/rvr/papers/OSDI04.pdf" rel="nofollow">Chain Based Replication</a>
which has two major shortcomings:</p>
<ul dir="auto">
<li>Replication algorithm is linear</li>
<li>Failure recovery procedure requires expensive topology changes</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Smallest Possible Usage Example</h2><a id="user-content-smallest-possible-usage-example" class="anchor" aria-label="Permalink: Smallest Possible Usage Example" href="#smallest-possible-usage-example"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The example below assumes a few things:</p>
<ul dir="auto">
<li>You are familiar with the basics of <a href="https://learnyousomeerlang.com/distribunomicon" rel="nofollow">distributed Erlang</a></li>
<li>Three Erlang nodes are started on the local machine or reachable resolvable hosts.
Their names are <code>ra1@hostname.local</code>, <code>ra2@hostname.local</code>, and <code>ra3@hostname.local</code> in the example below but your actual hostname will be different.
Therefore the naming scheme is <code>ra{N}@{hostname}</code>. This is not a Ra requirement so you are
welcome to use different node names and update the code accordingly.</li>
</ul>
<p dir="auto">Erlang nodes can be started using <code>rebar3 shell --name {node name}</code>. They will have Ra modules
on code path:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# replace hostname.local with your actual hostname
rebar3 shell --name ra1@hostname.local"><pre><span class="pl-c"><span class="pl-c">#</span> replace hostname.local with your actual hostname</span>
rebar3 shell --name ra1@hostname.local</pre></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# replace hostname.local with your actual hostname
rebar3 shell --name ra2@hostname.local"><pre><span class="pl-c"><span class="pl-c">#</span> replace hostname.local with your actual hostname</span>
rebar3 shell --name ra2@hostname.local</pre></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# replace hostname.local with your actual hostname
rebar3 shell --name ra3@hostname.local"><pre><span class="pl-c"><span class="pl-c">#</span> replace hostname.local with your actual hostname</span>
rebar3 shell --name ra3@hostname.local</pre></div>
<p dir="auto">After Ra nodes form a cluster, state machine commands can be performed.</p>
<p dir="auto">Here's what a small example looks like:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="%% All servers in a Ra cluster are named processes on Erlang nodes.
%% The Erlang nodes must have distribution enabled and be able to
%% communicate with each other.
%% See https://learnyousomeerlang.com/distribunomicon if you are new to Erlang/OTP.

%% These Erlang nodes will host Ra nodes. They are the &quot;seed&quot; and assumed to
%% be running or come online shortly after Ra cluster formation is started with ra:start_cluster/4.
ErlangNodes = ['ra1@hostname.local', 'ra2@hostname.local', 'ra3@hostname.local'],

%% This will check for Erlang distribution connectivity. If Erlang nodes
%% cannot communicate with each other, Ra nodes would not be able to cluster or communicate
%% either.
[io:format(&quot;Attempting to communicate with node ~s, response: ~s~n&quot;, [N, net_adm:ping(N)]) || N &lt;- ErlangNodes],

%% The Ra application has to be started on all nodes before it can be used.
[rpc:call(N, ra, start, []) || N &lt;- ErlangNodes],

%% Create some Ra server IDs to pass to the configuration. These IDs will be
%% used to address Ra nodes in Ra API functions.
ServerIds = [{quick_start, N} || N &lt;- ErlangNodes],

ClusterName = quick_start,
%% State machine that implements the logic and an initial state
Machine = {simple, fun erlang:'+'/2, 0},

%% Start a Ra cluster with an addition state machine that has an initial state of 0.
%% It's sufficient to invoke this function only on one Erlang node. For example, this
%% can be a &quot;designated seed&quot; node or the node that was first to start and did not discover
%% any peers after a few retries.
%%
%% Repeated startup attempts will fail even if the cluster is formed, has elected a leader
%% and is fully functional.
{ok, ServersStarted, _ServersNotStarted} = ra:start_cluster(default, ClusterName, Machine, ServerIds),

%% Add a number to the state machine.
%% Simple state machines always return the full state after each operation.
{ok, StateMachineResult, LeaderId} = ra:process_command(hd(ServersStarted), 5),

%% Use the leader id from the last command result for the next one
{ok, 12, LeaderId1} = ra:process_command(LeaderId, 7)."><pre><span class="pl-c"><span class="pl-c">%</span>% All servers in a Ra cluster are named processes on Erlang nodes.</span>
<span class="pl-c"><span class="pl-c">%</span>% The Erlang nodes must have distribution enabled and be able to</span>
<span class="pl-c"><span class="pl-c">%</span>% communicate with each other.</span>
<span class="pl-c"><span class="pl-c">%</span>% See https://learnyousomeerlang.com/distribunomicon if you are new to Erlang/OTP.</span>

<span class="pl-c"><span class="pl-c">%</span>% These Erlang nodes will host Ra nodes. They are the "seed" and assumed to</span>
<span class="pl-c"><span class="pl-c">%</span>% be running or come online shortly after Ra cluster formation is started with ra:start_cluster/4.</span>
<span class="pl-smi">ErlangNodes</span> <span class="pl-k">=</span> [<span class="pl-c1">'ra1@hostname.local'</span>, <span class="pl-c1">'ra2@hostname.local'</span>, <span class="pl-c1">'ra3@hostname.local'</span>],

<span class="pl-c"><span class="pl-c">%</span>% This will check for Erlang distribution connectivity. If Erlang nodes</span>
<span class="pl-c"><span class="pl-c">%</span>% cannot communicate with each other, Ra nodes would not be able to cluster or communicate</span>
<span class="pl-c"><span class="pl-c">%</span>% either.</span>
[<span class="pl-en">io</span>:<span class="pl-en">format</span>(<span class="pl-s"><span class="pl-pds">"</span>Attempting to communicate with node <span class="pl-c1">~s</span>, response: <span class="pl-c1">~s~n</span><span class="pl-pds">"</span></span>, [<span class="pl-smi">N</span>, <span class="pl-en">net_adm</span>:<span class="pl-en">ping</span>(<span class="pl-smi">N</span>)]) || <span class="pl-smi">N</span> <span class="pl-k">&lt;-</span> <span class="pl-smi">ErlangNodes</span>],

<span class="pl-c"><span class="pl-c">%</span>% The Ra application has to be started on all nodes before it can be used.</span>
[<span class="pl-en">rpc</span>:<span class="pl-en">call</span>(<span class="pl-smi">N</span>, <span class="pl-c1">ra</span>, <span class="pl-c1">start</span>, []) || <span class="pl-smi">N</span> <span class="pl-k">&lt;-</span> <span class="pl-smi">ErlangNodes</span>],

<span class="pl-c"><span class="pl-c">%</span>% Create some Ra server IDs to pass to the configuration. These IDs will be</span>
<span class="pl-c"><span class="pl-c">%</span>% used to address Ra nodes in Ra API functions.</span>
<span class="pl-smi">ServerIds</span> <span class="pl-k">=</span> [{<span class="pl-c1">quick_start</span>, <span class="pl-smi">N</span>} || <span class="pl-smi">N</span> <span class="pl-k">&lt;-</span> <span class="pl-smi">ErlangNodes</span>],

<span class="pl-smi">ClusterName</span> <span class="pl-k">=</span> <span class="pl-c1">quick_start</span>,
<span class="pl-c"><span class="pl-c">%</span>% State machine that implements the logic and an initial state</span>
<span class="pl-smi">Machine</span> <span class="pl-k">=</span> {<span class="pl-c1">simple</span>, <span class="pl-k">fun</span> <span class="pl-en">erlang</span>:<span class="pl-en">'+'</span>/<span class="pl-c1">2</span>, <span class="pl-c1">0</span>},

<span class="pl-c"><span class="pl-c">%</span>% Start a Ra cluster with an addition state machine that has an initial state of 0.</span>
<span class="pl-c"><span class="pl-c">%</span>% It's sufficient to invoke this function only on one Erlang node. For example, this</span>
<span class="pl-c"><span class="pl-c">%</span>% can be a "designated seed" node or the node that was first to start and did not discover</span>
<span class="pl-c"><span class="pl-c">%</span>% any peers after a few retries.</span>
<span class="pl-c"><span class="pl-c">%</span>%</span>
<span class="pl-c"><span class="pl-c">%</span>% Repeated startup attempts will fail even if the cluster is formed, has elected a leader</span>
<span class="pl-c"><span class="pl-c">%</span>% and is fully functional.</span>
{<span class="pl-c1">ok</span>, <span class="pl-smi">ServersStarted</span>, <span class="pl-smi">_ServersNotStarted</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">start_cluster</span>(<span class="pl-c1">default</span>, <span class="pl-smi">ClusterName</span>, <span class="pl-smi">Machine</span>, <span class="pl-smi">ServerIds</span>),

<span class="pl-c"><span class="pl-c">%</span>% Add a number to the state machine.</span>
<span class="pl-c"><span class="pl-c">%</span>% Simple state machines always return the full state after each operation.</span>
{<span class="pl-c1">ok</span>, <span class="pl-smi">StateMachineResult</span>, <span class="pl-smi">LeaderId</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">process_command</span>(<span class="pl-en">hd</span>(<span class="pl-smi">ServersStarted</span>), <span class="pl-c1">5</span>),

<span class="pl-c"><span class="pl-c">%</span>% Use the leader id from the last command result for the next one</span>
{<span class="pl-c1">ok</span>, <span class="pl-c1">12</span>, <span class="pl-smi">LeaderId1</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">process_command</span>(<span class="pl-smi">LeaderId</span>, <span class="pl-c1">7</span>).</pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Querying Machine State</h3><a id="user-content-querying-machine-state" class="anchor" aria-label="Permalink: Querying Machine State" href="#querying-machine-state"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Ra machines are only useful if their state can be queried. There are two types of queries:</p>
<ul dir="auto">
<li>Local queries return machine state on the target node</li>
<li>Leader queries return machine state from the leader node.
If a follower node is queried, the query command will be redirected to the leader.</li>
</ul>
<p dir="auto">Local queries are much more efficient but can return out-of-date machine state.
Leader queries offer best possible machine state consistency but potentially require
sending a request to a remote node.</p>
<p dir="auto">Use <code>ra:leader_query/{2,3}</code> to perform a leader query:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="%% find current Raft cluster leader
{ok, _Members, LeaderId} = ra:members(quick_start),
%% perform a leader query on the leader node
QueryFun = fun(StateVal) -&gt; StateVal end,
{ok, {_TermMeta, State}, LeaderId1} = ra:leader_query(LeaderId, QueryFun)."><pre><span class="pl-c"><span class="pl-c">%</span>% find current Raft cluster leader</span>
{<span class="pl-c1">ok</span>, <span class="pl-smi">_Members</span>, <span class="pl-smi">LeaderId</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">members</span>(<span class="pl-c1">quick_start</span>),
<span class="pl-c"><span class="pl-c">%</span>% perform a leader query on the leader node</span>
<span class="pl-smi">QueryFun</span> <span class="pl-k">=</span> <span class="pl-k">fun</span>(<span class="pl-smi">StateVal</span>) -&gt; <span class="pl-smi">StateVal</span> <span class="pl-k">end</span>,
{<span class="pl-c1">ok</span>, {<span class="pl-smi">_TermMeta</span>, <span class="pl-smi">State</span>}, <span class="pl-smi">LeaderId1</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">leader_query</span>(<span class="pl-smi">LeaderId</span>, <span class="pl-smi">QueryFun</span>).</pre></div>
<p dir="auto">Similarly, use <code>ra:local_query/{2,3}</code> to perform a local query:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="%% this is the replica hosted on the current Erlang node.
%% alternatively it can be constructed as {ClusterName, node()}
{ok, Members, _LeaderId} = ra:members(quick_start),
LocalReplicaId = lists:keyfind(node(), 2, Members),
%% perform a local query on the local node
QueryFun = fun(StateVal) -&gt; StateVal end,
{ok, {_TermMeta, State}, LeaderId1} = ra:local_query(LocalReplicaId, QueryFun)."><pre><span class="pl-c"><span class="pl-c">%</span>% this is the replica hosted on the current Erlang node.</span>
<span class="pl-c"><span class="pl-c">%</span>% alternatively it can be constructed as {ClusterName, node()}</span>
{<span class="pl-c1">ok</span>, <span class="pl-smi">Members</span>, <span class="pl-smi">_LeaderId</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">members</span>(<span class="pl-c1">quick_start</span>),
<span class="pl-smi">LocalReplicaId</span> <span class="pl-k">=</span> <span class="pl-en">lists</span>:<span class="pl-en">keyfind</span>(<span class="pl-en">node</span>(), <span class="pl-c1">2</span>, <span class="pl-smi">Members</span>),
<span class="pl-c"><span class="pl-c">%</span>% perform a local query on the local node</span>
<span class="pl-smi">QueryFun</span> <span class="pl-k">=</span> <span class="pl-k">fun</span>(<span class="pl-smi">StateVal</span>) -&gt; <span class="pl-smi">StateVal</span> <span class="pl-k">end</span>,
{<span class="pl-c1">ok</span>, {<span class="pl-smi">_TermMeta</span>, <span class="pl-smi">State</span>}, <span class="pl-smi">LeaderId1</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">local_query</span>(<span class="pl-smi">LocalReplicaId</span>, <span class="pl-smi">QueryFun</span>).</pre></div>
<p dir="auto">A query function is a single argument function that accepts current machine state
and returns any value (usually derived from the state).</p>
<p dir="auto">Both <code>ra:leader_query/2</code> and <code>ra:local_query/2</code> return machine term metadata, a result returned by the query
function, and current cluster leader ID.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Dynamically Changing Cluster Membership</h3><a id="user-content-dynamically-changing-cluster-membership" class="anchor" aria-label="Permalink: Dynamically Changing Cluster Membership" href="#dynamically-changing-cluster-membership"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Nodes can be added to or removed from a Ra cluster dynamically. Only one
cluster membership change at a time is allowed: concurrent changes
will be rejected by design.</p>
<p dir="auto">In this example, instead of starting a "pre-formed" cluster,
a local server is started and then members are added by calling <code>ra:add_member/2</code>.</p>
<p dir="auto">Start 3 Erlang nodes:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# replace hostname.local with your actual hostname
rebar3 shell --name ra1@hostname.local"><pre><span class="pl-c"><span class="pl-c">#</span> replace hostname.local with your actual hostname</span>
rebar3 shell --name ra1@hostname.local</pre></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# replace hostname.local with your actual hostname
rebar3 shell --name ra2@hostname.local"><pre><span class="pl-c"><span class="pl-c">#</span> replace hostname.local with your actual hostname</span>
rebar3 shell --name ra2@hostname.local</pre></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# replace hostname.local with your actual hostname
rebar3 shell --name ra3@hostname.local"><pre><span class="pl-c"><span class="pl-c">#</span> replace hostname.local with your actual hostname</span>
rebar3 shell --name ra3@hostname.local</pre></div>
<p dir="auto">Start the ra application:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="%% on ra1@hostname.local
ra:start().
% =&gt; ok"><pre><span class="pl-c"><span class="pl-c">%</span>% on ra1@hostname.local</span>
<span class="pl-en">ra</span>:<span class="pl-en">start</span>().
<span class="pl-c"><span class="pl-c">%</span> =&gt; ok</span></pre></div>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="%% on ra2@hostname.local
ra:start().
% =&gt; ok"><pre><span class="pl-c"><span class="pl-c">%</span>% on ra2@hostname.local</span>
<span class="pl-en">ra</span>:<span class="pl-en">start</span>().
<span class="pl-c"><span class="pl-c">%</span> =&gt; ok</span></pre></div>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="%% on ra3@hostname.local
ra:start().
% =&gt; ok"><pre><span class="pl-c"><span class="pl-c">%</span>% on ra3@hostname.local</span>
<span class="pl-en">ra</span>:<span class="pl-en">start</span>().
<span class="pl-c"><span class="pl-c">%</span> =&gt; ok</span></pre></div>
<p dir="auto">A single node cluster can be started from any node.</p>
<p dir="auto">For the purpose of this example, <code>ra2@hostname.local</code> is used as the starting member:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="ClusterName = dyn_members,
Machine = {simple, fun erlang:'+'/2, 0},

% Start a cluster
{ok, _, _} =  ra:start_cluster(default, ClusterName, Machine, [{dyn_members, 'ra2@hostname.local'}])."><pre><span class="pl-smi">ClusterName</span> <span class="pl-k">=</span> <span class="pl-c1">dyn_members</span>,
<span class="pl-smi">Machine</span> <span class="pl-k">=</span> {<span class="pl-c1">simple</span>, <span class="pl-k">fun</span> <span class="pl-en">erlang</span>:<span class="pl-en">'+'</span>/<span class="pl-c1">2</span>, <span class="pl-c1">0</span>},

<span class="pl-c"><span class="pl-c">%</span> Start a cluster</span>
{<span class="pl-c1">ok</span>, <span class="pl-c1">_</span>, <span class="pl-c1">_</span>} <span class="pl-k">=</span>  <span class="pl-en">ra</span>:<span class="pl-en">start_cluster</span>(<span class="pl-c1">default</span>, <span class="pl-smi">ClusterName</span>, <span class="pl-smi">Machine</span>, [{<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra2@hostname.local'</span>}]).</pre></div>
<p dir="auto">After the cluster is formed, members can be added.</p>
<p dir="auto">Add <code>ra1@hostname.local</code> by telling <code>ra2@hostname.local</code> about it
and starting a Ra replica (server) on <code>ra1@hostname.local</code> itself:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="% Add member
{ok, _, _} = ra:add_member({dyn_members, 'ra2@hostname.local'}, {dyn_members, 'ra1@hostname.local'}),

% Start the server
ok = ra:start_server(default, ClusterName, {dyn_members, 'ra1@hostname.local'}, Machine, [{dyn_members, 'ra2@hostname.local'}])."><pre><span class="pl-c"><span class="pl-c">%</span> Add member</span>
{<span class="pl-c1">ok</span>, <span class="pl-c1">_</span>, <span class="pl-c1">_</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">add_member</span>({<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra2@hostname.local'</span>}, {<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra1@hostname.local'</span>}),

<span class="pl-c"><span class="pl-c">%</span> Start the server</span>
<span class="pl-c1">ok</span> <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">start_server</span>(<span class="pl-c1">default</span>, <span class="pl-smi">ClusterName</span>, {<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra1@hostname.local'</span>}, <span class="pl-smi">Machine</span>, [{<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra2@hostname.local'</span>}]).</pre></div>
<p dir="auto">Add <code>ra3@hostname.local</code> to the cluster:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="% Add a new member
{ok, _, _} = ra:add_member({dyn_members, 'ra2@hostname.local'}, {dyn_members, 'ra3@hostname.local'}),

% Start the server
ok = ra:start_server(default, ClusterName, {dyn_members, 'ra3@hostname.local'}, Machine, [{dyn_members, 'ra2@hostname.local'}])."><pre><span class="pl-c"><span class="pl-c">%</span> Add a new member</span>
{<span class="pl-c1">ok</span>, <span class="pl-c1">_</span>, <span class="pl-c1">_</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">add_member</span>({<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra2@hostname.local'</span>}, {<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra3@hostname.local'</span>}),

<span class="pl-c"><span class="pl-c">%</span> Start the server</span>
<span class="pl-c1">ok</span> <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">start_server</span>(<span class="pl-c1">default</span>, <span class="pl-smi">ClusterName</span>, {<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra3@hostname.local'</span>}, <span class="pl-smi">Machine</span>, [{<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra2@hostname.local'</span>}]).</pre></div>
<p dir="auto">Check the members from any node:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="ra:members({dyn_members, node()}).
% =&gt; {ok,[{dyn_members,'ra1@hostname.local'},
% =&gt;      {dyn_members,'ra2@hostname.local'},
% =&gt;      {dyn_members,'ra3@hostname.local'}],
% =&gt;      {dyn_members,'ra2@hostname.local'}}"><pre><span class="pl-en">ra</span>:<span class="pl-en">members</span>({<span class="pl-c1">dyn_members</span>, <span class="pl-en">node</span>()}).
<span class="pl-c"><span class="pl-c">%</span> =&gt; {ok,[{dyn_members,'ra1@hostname.local'},</span>
<span class="pl-c"><span class="pl-c">%</span> =&gt;      {dyn_members,'ra2@hostname.local'},</span>
<span class="pl-c"><span class="pl-c">%</span> =&gt;      {dyn_members,'ra3@hostname.local'}],</span>
<span class="pl-c"><span class="pl-c">%</span> =&gt;      {dyn_members,'ra2@hostname.local'}}</span></pre></div>
<p dir="auto">If a node wants to leave the cluster, it can use <code>ra:leave_and_terminate/3</code>
and specify itself as the target:</p>
<p dir="auto">Temporarily add a new node, say <code>ra4@hostname.local</code>, to the cluster:</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="% Add a new member
{ok, _, _} = ra:add_member({dyn_members, 'ra2@hostname.local'}, {dyn_members, 'ra4@hostname.local'}),

% Start the server
ok = ra:start_server(default, ClusterName, {dyn_members, 'ra4@hostname.local'}, Machine, [{dyn_members, 'ra2@hostname.local'}]).

%% on ra4@hostname.local
ra:leave_and_terminate(default, {ClusterName, node()}, {ClusterName, node()}).

ra:members({ClusterName, node()}).
% =&gt; {ok,[{dyn_members,'ra1@hostname.local'},
% =&gt;      {dyn_members,'ra2@hostname.local'},
% =&gt;      {dyn_members,'ra3@hostname.local'}],
% =&gt;      {dyn_members,'ra2@hostname.local'}}"><pre><span class="pl-c"><span class="pl-c">%</span> Add a new member</span>
{<span class="pl-c1">ok</span>, <span class="pl-c1">_</span>, <span class="pl-c1">_</span>} <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">add_member</span>({<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra2@hostname.local'</span>}, {<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra4@hostname.local'</span>}),

<span class="pl-c"><span class="pl-c">%</span> Start the server</span>
<span class="pl-c1">ok</span> <span class="pl-k">=</span> <span class="pl-en">ra</span>:<span class="pl-en">start_server</span>(<span class="pl-c1">default</span>, <span class="pl-smi">ClusterName</span>, {<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra4@hostname.local'</span>}, <span class="pl-smi">Machine</span>, [{<span class="pl-c1">dyn_members</span>, <span class="pl-c1">'ra2@hostname.local'</span>}]).

<span class="pl-c"><span class="pl-c">%</span>% on ra4@hostname.local</span>
<span class="pl-en">ra</span>:<span class="pl-en">leave_and_terminate</span>(<span class="pl-c1">default</span>, {<span class="pl-smi">ClusterName</span>, <span class="pl-en">node</span>()}, {<span class="pl-smi">ClusterName</span>, <span class="pl-en">node</span>()}).

<span class="pl-en">ra</span>:<span class="pl-en">members</span>({<span class="pl-smi">ClusterName</span>, <span class="pl-en">node</span>()}).
<span class="pl-c"><span class="pl-c">%</span> =&gt; {ok,[{dyn_members,'ra1@hostname.local'},</span>
<span class="pl-c"><span class="pl-c">%</span> =&gt;      {dyn_members,'ra2@hostname.local'},</span>
<span class="pl-c"><span class="pl-c">%</span> =&gt;      {dyn_members,'ra3@hostname.local'}],</span>
<span class="pl-c"><span class="pl-c">%</span> =&gt;      {dyn_members,'ra2@hostname.local'}}</span></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Other examples</h3><a id="user-content-other-examples" class="anchor" aria-label="Permalink: Other examples" href="#other-examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See <a href="docs/internals/STATE_MACHINE_TUTORIAL.md">Ra state machine tutorial</a>
for how to write more sophisticated state machines by implementing
the <code>ra_machine</code> behaviour.</p>
<p dir="auto">A <a href="https://github.com/rabbitmq/ra-kv-store">Ra-based key/value store example</a>
is available in a separate repository.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Documentation</h2><a id="user-content-documentation" class="anchor" aria-label="Permalink: Documentation" href="#documentation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="https://hex.pm/packages/ra" rel="nofollow">API reference</a></li>
<li>How to write a Ra state machine: <a href="docs/internals/STATE_MACHINE_TUTORIAL.md">Ra state machine tutorial</a></li>
<li>Design and implementation details: <a href="docs/internals/INTERNALS.md">Ra internals guide</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Examples</h3><a id="user-content-examples" class="anchor" aria-label="Permalink: Examples" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="https://github.com/rabbitmq/ra-kv-store">Ra-based key/value store</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Configuration Reference</h2><a id="user-content-configuration-reference" class="anchor" aria-label="Permalink: Configuration Reference" href="#configuration-reference"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
    <tbody><tr>
        <td>Key</td>
        <td>Description</td>
        <td>Data Type</td>
    </tr>
    <tr>
        <td>data_dir</td>
        <td>A directory name where Ra node will store its data</td>
        <td>Local directory path</td>
    </tr>
    <tr>
        <td>wal_data_dir</td>
        <td>
            A directory name where Ra will store it's WAL (Write Ahead Log) data.
            If unspecified, `data_dir` is used.
        </td>
        <td>Local directory path</td>
    </tr>
    <tr>
        <td>wal_max_size_bytes</td>
        <td>The maximum size of the WAL in bytes. Default: 512 MB</td>
        <td>Positive integer</td>
    </tr>
    <tr>
        <td>wal_max_entries</td>
        <td>The maximum number of entries per WAL file. Default: undefined</td>
        <td>Positive integer</td>
    </tr>
    <tr>
        <td>wal_compute_checksums</td>
        <td>Indicate whether the wal should compute and validate checksums. Default: `true`</td>
        <td>Boolean</td>
    </tr>
    <tr>
        <td>wal_write_strategy</td>
        <td>
            <ul dir="auto">
                <li>
                    <code>default</code>: used by default. <code>write(2)</code> system calls are delayed until a buffer is due to be flushed. Then it writes all the data in a single call then <code>fsync</code>s. Fastest option but incurs some additional memory use.
                </li>
                <li>
                    <code>o_sync</code>: Like default but will try to open the file with O_SYNC and thus won't need the additional <code>fsync(2)</code> system call. If it fails to open the file with this flag this mode falls back to default.
                </li>
            </ul>
        </td>
        <td>Enumeration: <code>default</code> | <code>o_sync</code></td>
    </tr>
    <tr>
        <td>wal_sync_method</td>
        <td>
            <ul dir="auto">
                <li>
                    <code>datasync</code>: used by default. Uses the <code>fdatasync(2)</code> system call after each batch. This avoids flushing
                    file meta-data after each write batch and thus may be slightly faster than sync on some system. When datasync is configured the wal will try to pre-allocate the entire WAL file.
                    Not all systems support <code>fdatasync</code>. Please consult system
                    documentation and configure it to use sync instead if it is not supported.
                </li>
                <li>
                    <code>sync</code>: uses the fsync system call after each batch.
                </li>
            </ul>
        </td>
        <td>Enumeration: <code>datasync</code> | <code>sync</code></td>
    </tr>
    <tr>
        <td>logger_module</td>
        <td>
            Allows the configuration of a custom logger module. The default is logger.
            The module must implement a function of the same signature
            as <a href="http://erlang.org/doc/man/logger.html#log-4" rel="nofollow">logger:log/4</a> (the variant that takes a format not the variant that takes a function).
        </td>
        <td>Atom</td>
    </tr>
    <tr>
        <td>wal_max_batch_size</td>
        <td>
            Controls the internal max batch size that the WAL will accept.
            Higher numbers may result in higher memory use. Default: 32768.
        </td>
        <td>Positive integer</td>
    </tr>
    <tr>
        <td>wal_hibernate_after</td>
        <td>
            Enables hibernation after a timeout of inactivity for the WAL process.
        </td>
        <td>Milliseconds</td>
    </tr>
    <tr>
        <td>metrics_key</td>
        <td>Metrics key. The key used to write metrics into the ra_metrics table.</td>
        <td>Atom</td>
    </tr>
    <tr>
        <td>low_priority_commands_flush_size</td>
        <td>
            When commands are pipelined using the low priority mode Ra tries to hold them
            back in favour of normal priority commands. This setting determines the number
            of low priority commands that are added to the log each flush cycle. Default: 25
        </td>
        <td>Positive integer</td>
    </tr>
    <tr>
        <td>segment_compute_checksums</td>
        <td>Indicate whether the segment writer should compute and validate checksums. Default: `true`</td>
        <td>Boolean</td>
    </tr>
</tbody></table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Logging</h2><a id="user-content-logging" class="anchor" aria-label="Permalink: Logging" href="#logging"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Ra will use default OTP <code>logger</code> by default, unless <code>logger_module</code>
configuration key is used to override.</p>
<p dir="auto">To change log level to <code>debug</code> for all applications, use</p>
<div class="highlight highlight-source-erlang notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="logger:set_primary_config(level, debug)."><pre><span class="pl-en">logger</span>:<span class="pl-en">set_primary_config</span>(<span class="pl-c1">level</span>, <span class="pl-c1">debug</span>).</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Ra versioning</h2><a id="user-content-ra-versioning" class="anchor" aria-label="Permalink: Ra versioning" href="#ra-versioning"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Ra attempts to follow <a href="https://semver.org/" rel="nofollow">Semantic Versioning</a>.</p>
<p dir="auto">The modules that form part of the public API are:</p>
<ul dir="auto">
<li><code>ra</code></li>
<li><code>ra_machine</code> (behaviour callbacks only)</li>
<li><code>ra_aux</code></li>
<li><code>ra_system</code></li>
<li><code>ra_counters</code> (counter keys may vary between minors)</li>
<li><code>ra_leaderboard</code></li>
<li><code>ra_env</code></li>
<li><code>ra_directory</code></li>
<li><code>ra_flru</code></li>
<li><code>ra_log_read_plan</code></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Copyright and License</h2><a id="user-content-copyright-and-license" class="anchor" aria-label="Permalink: Copyright and License" href="#copyright-and-license"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">(c) 2017-2024 Broadcom. All Rights Reserved. The term "Broadcom" refers to
Broadcom Inc. and/or its subsidiaries.</p>
<p dir="auto">Dual licensed under the Apache License Version 2.0 and
Mozilla Public License Version 2.0.</p>
<p dir="auto">This means that the user can consider the library to be licensed under
<strong>any of the licenses from the list</strong> above. For example, you may
choose the Apache Public License 2.0 and include this library into a
commercial product.</p>
<p dir="auto">See <a href="./LICENSE">LICENSE</a> for details.</p>
</article></div>