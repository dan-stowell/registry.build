<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Bazel GitOps Rules</h1><a id="user-content-bazel-gitops-rules" class="anchor" aria-label="Permalink: Bazel GitOps Rules" href="#bazel-gitops-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/adobe/rules_gitops/workflows/CI/badge.svg?branch=master&amp;event=push"><img src="https://github.com/adobe/rules_gitops/workflows/CI/badge.svg?branch=master&amp;event=push" alt="CI" style="max-width: 100%;"></a></p>
<p dir="auto">Bazel GitOps Rules provides tooling to bridge the gap between Bazel (for hermetic, reproducible, container builds) and continuous, git-operation driven, deployments. Users author standard kubernetes manifests and kustomize overlays for their services. Bazel GitOps Rules handles image push and substitution, applies necessary kustomizations, and handles content addressed substitutions of all object references (configmaps, secrets, etc). Bazel targets are exposed for applying the rendered manifest directly to a Kubernetes cluster, or into version control facilitating deployment via Git operations.</p>
<p dir="auto">Bazel GitOps Rules is an alternative to <a href="https://github.com/bazelbuild/rules_k8s">rules_k8s</a>. The main differences are:</p>
<ul dir="auto">
<li>Utilizes and integrates the full set of <a href="https://kustomize.io/" rel="nofollow">Kustomize</a> capabilities for generating manifests.</li>
<li>Implements GitOps target.</li>
<li>Supports personal namespace deployments.</li>
<li>Provides integration test setup utility.</li>
<li>Speeds up deployments iterations:
<ul dir="auto">
<li>The results manifests are rendered without pushing containers.</li>
<li>Pushes all the images in parallel.</li>
</ul>
</li>
<li>Provides an utility that creates GitOps pull requests.</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Rules</h2><a id="user-content-rules" class="anchor" aria-label="Permalink: Rules" href="#rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="#k8s_deploy">k8s_deploy</a></li>
<li><a href="#k8s_test_setup">k8s_test_setup</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Guides</h2><a id="user-content-guides" class="anchor" aria-label="Permalink: Guides" href="#guides"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="#base-manifests-and-overlays">Base Manifests and Overlays</a></li>
<li><a href="#generating-configmaps">Generating Configmaps</a></li>
<li><a href="#injecting-docker-images">Injecting Docker Images</a></li>
<li><a href="#adding-dependencies">Adding Dependencies</a></li>
<li><a href="#gitops-and-deployment">GitOps and Deployment</a></li>
<li><a href="#integration-testing-support">Integration Testing Support</a></li>
</ul>
<p dir="auto"><a name="user-content-installation"></a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Installation</h2><a id="user-content-installation" class="anchor" aria-label="Permalink: Installation" href="#installation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">From the release you wish to use:
<a href="https://github.com/adobe/rules_gitops/releases">https://github.com/adobe/rules_gitops/releases</a>
copy the WORKSPACE snippet into your <code>WORKSPACE</code> file.</p>
<p dir="auto"><a name="user-content-k8s_deploy"></a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">k8s_deploy</h2><a id="user-content-k8s_deploy" class="anchor" aria-label="Permalink: k8s_deploy" href="#k8s_deploy"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>k8s_deploy</code> creates rules that produce the <code>.apply</code> and <code>.gitops</code> targets <code>k8s_deploy</code> is defined in <a href="./skylib/k8s.bzl">k8s.bzl</a>. <code>k8s_deploy</code> takes the files listed in the <code>manifests</code>, <code>patches</code>, and <code>configmaps_srcs</code> attributes and combines (<strong>renders</strong>) them into one  YAML file. This happens when you <code>bazel build</code> or <code>bazel run</code> a target created by the <code>k8s_deploy</code>. The file is created at <code>bazel-bin/path/to/package/name.yaml</code>. When you run a <code>.apply</code> target, it runs <code>kubectl apply</code> on this file. When you run a <code>.gitops</code> target, it copies this file to
the appropriate location in the same os separate repository.</p>
<p dir="auto">For example, let's look at the <a href="./examples/helloworld/BUILD">example's k8s_deploy</a>. We can peek at the file containing the rendered K8s manifests:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cd examples
bazel run //helloworld:mynamespace.show"><pre><span class="pl-c1">cd</span> examples
bazel run //helloworld:mynamespace.show</pre></div>
<p dir="auto">When you run <code>bazel run ///helloworld:mynamespace.apply</code>, it applies this file into your personal (<code>{BUILD_USER}</code>) namespace. Viewing the rendered files with <code>.show</code> can be useful for debugging issues with invalid or misconfigured manifests.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em><strong>cluster</strong></em></td>
<td><code>None</code></td>
<td>The name of the cluster in which these manifests will be applied.</td>
</tr>
<tr>
<td><em><strong>namespace</strong></em></td>
<td><code>None</code></td>
<td>The target namespace to assign to all manifests. Any namespace value in the source manifests will be replaced or added if not specified.</td>
</tr>
<tr>
<td><em><strong>user</strong></em></td>
<td><code>{BUILD_USER}</code></td>
<td>The user passed to kubectl in .apply rule. Must exist in users ~/.kube/config</td>
</tr>
<tr>
<td><em><strong>configmaps_srcs</strong></em></td>
<td><code>None</code></td>
<td>A list of files (of any type) that will be combined into configmaps. See <a href="#generating-configmaps">Generating Configmaps</a>.</td>
</tr>
<tr>
<td><em><strong>configmaps_renaming</strong></em></td>
<td><code>None</code></td>
<td>Configmaps/Secrets renaming policy. Could be None or 'hash'. 'hash' renaming policy is used to add a unique suffix to the generated configmap or secret name. All references to the configmap or secret in other manifests will be replaced with the generated name.</td>
</tr>
<tr>
<td><em><strong>secrets_srcs</strong></em></td>
<td><code>None</code></td>
<td>A list of files (of any type) that will be combined into a secret similar to configmaps.</td>
</tr>
<tr>
<td><em><strong>manifests</strong></em></td>
<td><code>glob(['*.yaml','*.yaml.tpl'])</code></td>
<td>A list of base manifests. See <a href="#base-manifests-and-overlays">Base Manifests and Overlays</a>.</td>
</tr>
<tr>
<td><em><strong>name_prefix</strong></em></td>
<td><code>None</code></td>
<td>Adds prefix to the names of all resources defined in manifests.</td>
</tr>
<tr>
<td><em><strong>name_suffix</strong></em></td>
<td><code>None</code></td>
<td>Adds suffix to the names of all resources defined in manifests.</td>
</tr>
<tr>
<td><em><strong>patches</strong></em></td>
<td><code>None</code></td>
<td>A list of patch files to overlay the base manifests. See <a href="#base-manifests-and-overlays">Base Manifests and Overlays</a>.</td>
</tr>
<tr>
<td><em><strong>image_name_patches</strong></em></td>
<td><code>None</code></td>
<td>A dict of image names that will be replaced with new ones. See <a href="https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/images/" rel="nofollow">kustomization images</a>.</td>
</tr>
<tr>
<td><em><strong>image_tag_patches</strong></em></td>
<td><code>None</code></td>
<td>A dict of image names which tags be replaced with new ones. See <a href="https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/images/" rel="nofollow">kustomization images</a>.</td>
</tr>
<tr>
<td><em><strong>substitutions</strong></em></td>
<td><code>None</code></td>
<td>Does parameter substitution in all the manifests (including configmaps). This should generally be limited to "CLUSTER" and "NAMESPACE" only. Any other replacements should be done with overlays.</td>
</tr>
<tr>
<td><em><strong>configurations</strong></em></td>
<td><code>[]</code></td>
<td>A list of files with <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/examples/transformerconfigs/README.md">kustomize configurations</a>.</td>
</tr>
<tr>
<td><em><strong>prefix_suffix_app_labels</strong></em></td>
<td><code>False</code></td>
<td>Add the bundled configuration file allowing adding suffix and prefix to labels <code>app</code> and <code>app.kubernetes.io/name</code> and respective selector in Deployment.</td>
</tr>
<tr>
<td><em><strong>common_labels</strong></em></td>
<td><code>{}</code></td>
<td>A map of labels that should be added to all objects and object templates.</td>
</tr>
<tr>
<td><em><strong>common_annotations</strong></em></td>
<td><code>{}</code></td>
<td>A map of annotations that should be added to all objects and object templates.</td>
</tr>
<tr>
<td><em><strong>start_tag</strong></em></td>
<td><code>"{{"</code></td>
<td>The character start sequence used for substitutions.</td>
</tr>
<tr>
<td><em><strong>end_tag</strong></em></td>
<td><code>"}}"</code></td>
<td>The character end sequence used for substitutions.</td>
</tr>
<tr>
<td><em><strong>deps</strong></em></td>
<td><code>[]</code></td>
<td>A list of dependencies used to drive <code>k8s_deploy</code> functionality (i.e. <code>deps_aliases</code>).</td>
</tr>
<tr>
<td><em><strong>deps_aliases</strong></em></td>
<td><code>{}</code></td>
<td>A dict of labels of file dependencies. File dependency contents are available for template expansion in manifests as <code>{{imports.&lt;label&gt;}}</code>. Each dependency in this dictionary should be present in the <code>deps</code> attribute.</td>
</tr>
<tr>
<td><em><strong>objects</strong></em></td>
<td><code>[]</code></td>
<td>A list of other instances of <code>k8s_deploy</code> that this one depends on. See <a href="#adding-dependencies">Adding Dependencies</a>.</td>
</tr>
<tr>
<td><em><strong>images</strong></em></td>
<td><code>{}</code></td>
<td>A dict of labels of Docker images. See <a href="#injecting-docker-images">Injecting Docker Images</a>.</td>
</tr>
<tr>
<td><em><strong>image_digest_tag</strong></em></td>
<td><code>False</code></td>
<td>A flag for whether or not to tag the image with the container digest.</td>
</tr>
<tr>
<td><em><strong>image_registry</strong></em></td>
<td><code>docker.io</code></td>
<td>The registry to push images to.</td>
</tr>
<tr>
<td><em><strong>image_repository</strong></em></td>
<td><code>None</code></td>
<td>The repository to push images to. By default, this is generated from the current package path.</td>
</tr>
<tr>
<td><em><strong>image_repository_prefix</strong></em></td>
<td><code>None</code></td>
<td>Add a prefix to the image_repository. Can be used to upload the images in</td>
</tr>
<tr>
<td><em><strong>image_pushes</strong></em></td>
<td><code>[]</code></td>
<td>A list of labels implementing K8sPushInfo referring image uploaded into registry. See <a href="#injecting-docker-images">Injecting Docker Images</a>.</td>
</tr>
<tr>
<td><em><strong>release_branch_prefix</strong></em></td>
<td><code>master</code></td>
<td>A git branch name/prefix. Automatically run GitOps while building this branch. See <a href="#gitops_and_deployment">GitOps and Deployment</a>.</td>
</tr>
<tr>
<td><em><strong>deployment_branch</strong></em></td>
<td><code>None</code></td>
<td>Automatic GitOps output will appear in a branch and PR with this name. See <a href="#gitops_and_deployment">GitOps and Deployment</a>.</td>
</tr>
<tr>
<td><em><strong>gitops_path</strong></em></td>
<td><code>cloud</code></td>
<td>Path within the git repo where gitops files get generated into</td>
</tr>
<tr>
<td><em><strong>tags</strong></em></td>
<td><code>[]</code></td>
<td>See <a href="https://docs.bazel.build/versions/master/be/common-definitions.html#common-attributes" rel="nofollow">Bazel docs on tags</a>.</td>
</tr>
<tr>
<td><em><strong>visibility</strong></em></td>
<td><a href="https://docs.bazel.build/versions/master/be/functions.html#package.default_visibility" rel="nofollow">Default_visibility</a></td>
<td>Changes the visibility of all rules generated by this macro. See <a href="https://docs.bazel.build/versions/master/be/common-definitions.html#common-attributes" rel="nofollow">Bazel docs on visibility</a>.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><a name="user-content-base-manifests-and-overlays"></a></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Base Manifests and Overlays</h3><a id="user-content-base-manifests-and-overlays" class="anchor" aria-label="Permalink: Base Manifests and Overlays" href="#base-manifests-and-overlays"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The manifests listed in the <em>manifests</em> attribute are the base manifests used by the deployment. This is where the important manifests like Deployments, Services, etc. are listed.</p>
<p dir="auto">The base manifests will be modified by most of the other <code>k8s_deploy</code> attributes like <code>substitutions</code> and <code>images</code>. Additionally, they can be modified to configure them different clusters/namespaces/etc. using <strong>overlays</strong>.</p>
<p dir="auto">To demonstrate, let's go over hypothetical multi cluster deployment.</p>
<p dir="auto">Here is the fragment of the <code>k8s_deploy</code> rule that is responsible for generating manifest variants per CLOUD, CLUSTER, and NAMESPACE :</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="k8s_deploy(
    ...
    manifests = glob([                 # (1)
      &quot;manifests/*.yaml&quot;,
      &quot;manifests/%s/*.yaml&quot; % (CLOUD),
    ]),
    patches = glob([                   # (2)
      &quot;overlays/*.yaml&quot;,
      &quot;overlays/%s/*.yaml&quot; % (CLOUD),
      &quot;overlays/%s/%s/*.yaml&quot; % (CLOUD, NAMESPACE),
      &quot;overlays/%s/%s/%s/*.yaml&quot; % (CLOUD, NAMESPACE, CLUSTER),
    ]),
    ...
)"><pre><span class="pl-en">k8s_deploy</span>(
    ...
    <span class="pl-s1">manifests</span> <span class="pl-c1">=</span> <span class="pl-en">glob</span>([                 <span class="pl-c"># (1)</span>
      <span class="pl-s">"manifests/*.yaml"</span>,
      <span class="pl-s">"manifests/%s/*.yaml"</span> <span class="pl-c1">%</span> (<span class="pl-c1">CLOUD</span>),
    ]),
    <span class="pl-s1">patches</span> <span class="pl-c1">=</span> <span class="pl-en">glob</span>([                   <span class="pl-c"># (2)</span>
      <span class="pl-s">"overlays/*.yaml"</span>,
      <span class="pl-s">"overlays/%s/*.yaml"</span> <span class="pl-c1">%</span> (<span class="pl-c1">CLOUD</span>),
      <span class="pl-s">"overlays/%s/%s/*.yaml"</span> <span class="pl-c1">%</span> (<span class="pl-c1">CLOUD</span>, <span class="pl-c1">NAMESPACE</span>),
      <span class="pl-s">"overlays/%s/%s/%s/*.yaml"</span> <span class="pl-c1">%</span> (<span class="pl-c1">CLOUD</span>, <span class="pl-c1">NAMESPACE</span>, <span class="pl-c1">CLUSTER</span>),
    ]),
    ...
)</pre></div>
<p dir="auto">The manifests list <code>(1)</code> combines common base manifests and <code>CLOUD</code> specific manifests.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="manifests
├── aws
│   └── pvc.yaml
├── onprem
│   ├── pv.yaml
│   └── pvc.yaml
├── deployment.yaml
├── ingress.yaml
└── service.yaml"><pre class="notranslate"><code>manifests
├── aws
│   └── pvc.yaml
├── onprem
│   ├── pv.yaml
│   └── pvc.yaml
├── deployment.yaml
├── ingress.yaml
└── service.yaml
</code></pre></div>
<p dir="auto">Here we see that <code>aws</code> and <code>onprem</code> clouds have different persistence configurations <code>aws/pvc.yaml</code> and <code>onprem/pvc.yaml</code>.</p>
<p dir="auto">The patches list <code>(2)</code> requires more granular configuration that introduces 3 levels of customization: CLOUD, NAMESPACE, and CLUSTER. Each manifest fragment in the overlays subtree applied as <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md">strategic merge patch</a> update operation.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="overlays
├── aws
│   ├── deployment.yaml
│   ├── prod
│   │   ├── deployment.yaml
│   │   └── us-east-1
│   │       └── deployment.yaml
│   └── uat
│       └── deployment.yaml
└── onprem
    ├── prod
    │   ├── deployment.yaml
    │   └── us-east
    │       └── deployment.yaml
    └── uat
        └── deployment.yaml"><pre class="notranslate"><code>overlays
├── aws
│   ├── deployment.yaml
│   ├── prod
│   │   ├── deployment.yaml
│   │   └── us-east-1
│   │       └── deployment.yaml
│   └── uat
│       └── deployment.yaml
└── onprem
    ├── prod
    │   ├── deployment.yaml
    │   └── us-east
    │       └── deployment.yaml
    └── uat
        └── deployment.yaml
</code></pre></div>
<p dir="auto">That looks like a lot. But lets try to decode what is happening here:</p>
<ol dir="auto">
<li><code>aws/deployment.yaml</code> adds persistent volume reference specific to all AWS deployments.</li>
<li><code>aws/prod/deployment.yaml</code> modifies main container CPU and memory requirements in production configurations.</li>
<li><code>aws/prod/us-east-1/deployment.yaml</code> adds monitoring sidecar.</li>
</ol>
<p dir="auto"><a name="user-content-generating-configmaps"></a></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Generating Configmaps</h3><a id="user-content-generating-configmaps" class="anchor" aria-label="Permalink: Generating Configmaps" href="#generating-configmaps"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Configmaps are a special case of manifests. They can be rendered from a collection of files of any kind (.yaml, .properties, .xml, .sh, whatever). Let's use hypothetical Grafana deployment as an example:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="[
    k8s_deploy(
        name = NAME,
        cluster = CLUSTER,
        configmaps_srcs = glob([                 # (1)
            &quot;configmaps/%s/**/*&quot; % CLUSTER
        ]),
        configmaps_renaming = 'hash',            # (2)

        ...
    )
    for NAME, CLUSTER, NAMESPACE in [
        (&quot;mynamespace&quot;, &quot;dev&quot;, &quot;{BUILD_USER}&quot;),  # (3)
        (&quot;prod-grafana&quot;, &quot;prod&quot;, &quot;prod&quot;),        # (4)
    ]
]"><pre>[
    <span class="pl-en">k8s_deploy</span>(
        <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-c1">NAME</span>,
        <span class="pl-s1">cluster</span> <span class="pl-c1">=</span> <span class="pl-c1">CLUSTER</span>,
        <span class="pl-s1">configmaps_srcs</span> <span class="pl-c1">=</span> <span class="pl-en">glob</span>([                 <span class="pl-c"># (1)</span>
            <span class="pl-s">"configmaps/%s/**/*"</span> <span class="pl-c1">%</span> <span class="pl-c1">CLUSTER</span>
        ]),
        <span class="pl-s1">configmaps_renaming</span> <span class="pl-c1">=</span> <span class="pl-s">'hash'</span>,            <span class="pl-c"># (2)</span>

        ...
    )
    <span class="pl-k">for</span> <span class="pl-c1">NAME</span>, <span class="pl-c1">CLUSTER</span>, <span class="pl-c1">NAMESPACE</span> <span class="pl-c1">in</span> [
        (<span class="pl-s">"mynamespace"</span>, <span class="pl-s">"dev"</span>, <span class="pl-s">"{BUILD_USER}"</span>),  <span class="pl-c"># (3)</span>
        (<span class="pl-s">"prod-grafana"</span>, <span class="pl-s">"prod"</span>, <span class="pl-s">"prod"</span>),        <span class="pl-c"># (4)</span>
    ]
]</pre></div>
<p dir="auto">Here we generate two <code>k8s_deploy</code> targets, one for <code>mynamespace</code> <code>(3)</code>, another for production deployment <code>(4)</code>.</p>
<p dir="auto">The directory structure of <code>configmaps</code> looks like this:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="grafana
└── configmaps
    ├── dev
    │   └── grafana
    │       └── ldap.toml
    └── prod
        └── grafana
            └── ldap.toml"><pre class="notranslate"><code>grafana
└── configmaps
    ├── dev
    │   └── grafana
    │       └── ldap.toml
    └── prod
        └── grafana
            └── ldap.toml
</code></pre></div>
<p dir="auto">The <code>configmaps_srcs</code> parameter <code>(1)</code> will get resolved into the patterns <code>configmaps/dev/**/*</code> and <code>configmaps/prod/**/*</code>. The result of rendering the manifests <code>bazel run //grafana:prod-grafana.show</code> will have following manifest fragment:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: v1
data:
  ldap.toml: |
    [[servers]]
    ...
kind: ConfigMap
metadata:
  name: grafana-k75h878g4f
  namespace: ops-prod"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-c1">v1</span>
<span class="pl-ent">data</span>:
  <span class="pl-ent">ldap.toml</span>: <span class="pl-s">|</span>
<span class="pl-s">    [[servers]]</span>
<span class="pl-s">    ...</span>
<span class="pl-s"></span><span class="pl-ent">kind</span>: <span class="pl-s">ConfigMap</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">grafana-k75h878g4f</span>
  <span class="pl-ent">namespace</span>: <span class="pl-s">ops-prod</span></pre></div>
<p dir="auto">The name of directory on the first level of glob patten <code>grafana</code> become the configmap name. The <code>ldap.toml</code> file on the next level were embedded into the configmap.</p>
<p dir="auto">In this example, the configmap renaming policy <code>(2)</code> is set to <code>hash</code>, so the configmap's name appears as <code>grafana-k75h878g4f</code>. (If the renaming policy was <code>None</code>, the configmap's name would remain as <code>grafana</code>.) All the references to the <code>grafana</code> configmap in other manifests are replaced with the generated name:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: apps/v1
kind: Deployment
spec:
  template:
    spec:
      containers:
      volumes:
      ...
      - configMap:
          items:
          - key: ldap.toml
            path: ldap.toml
          name: grafana-k75h878g4f
        name: grafana-ldap"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-s">apps/v1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">Deployment</span>
<span class="pl-ent">spec</span>:
  <span class="pl-ent">template</span>:
    <span class="pl-ent">spec</span>:
      <span class="pl-ent">containers</span>:
      <span class="pl-ent">volumes</span>:
      <span class="pl-s">...</span>
      - <span class="pl-ent">configMap</span>:
          <span class="pl-ent">items</span>:
          - <span class="pl-ent">key</span>: <span class="pl-s">ldap.toml</span>
            <span class="pl-ent">path</span>: <span class="pl-s">ldap.toml</span>
          <span class="pl-ent">name</span>: <span class="pl-s">grafana-k75h878g4f</span>
        <span class="pl-ent">name</span>: <span class="pl-s">grafana-ldap</span></pre></div>
<p dir="auto"><a name="user-content-injecting-docker-images"></a></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Injecting Docker Images</h3><a id="user-content-injecting-docker-images" class="anchor" aria-label="Permalink: Injecting Docker Images" href="#injecting-docker-images"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Third-party Docker images can be referenced directly in K8s manifests, but for most apps, we need to run our own images. The images are built in the Bazel build pipeline using <a href="https://github.com/bazelbuild/rules_docker">rules_docker</a>. For example, the <code>java_image</code> rule creates an image of a Java application from Java source code, dependencies, and configuration.</p>
<p dir="auto">Here's a (very contrived) example of how this ties in with <code>k8s_deploy</code>. Here's the <code>BUILD</code> file located in the package <code>//examples</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="java_image(
    name = &quot;helloworld_image&quot;,
    srcs = glob([&quot;*.java&quot;]),
    ...
)
k8s_deploy(
    name = &quot;helloworld&quot;,
    manifests = [&quot;helloworld.yaml&quot;],
    images = {
        &quot;helloworld_image&quot;: &quot;:helloworld_image&quot;,  # (1)
    }
)"><pre><span class="pl-en">java_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"helloworld_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> <span class="pl-en">glob</span>([<span class="pl-s">"*.java"</span>]),
    ...
)
<span class="pl-en">k8s_deploy</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"helloworld"</span>,
    <span class="pl-s1">manifests</span> <span class="pl-c1">=</span> [<span class="pl-s">"helloworld.yaml"</span>],
    <span class="pl-s1">images</span> <span class="pl-c1">=</span> {
        <span class="pl-s">"helloworld_image"</span>: <span class="pl-s">":helloworld_image"</span>,  <span class="pl-c"># (1)</span>
    }
)</pre></div>
<p dir="auto">And here's <code>helloworld.yaml</code>:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: v1
kind: Pod
metadata:
  name: helloworld
spec:
  containers:
    - image: //examples:helloworld_image  # (2)"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-c1">v1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">Pod</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">helloworld</span>
<span class="pl-ent">spec</span>:
  <span class="pl-ent">containers</span>:
    - <span class="pl-ent">image</span>: <span class="pl-s">//examples:helloworld_image  </span><span class="pl-c"><span class="pl-c">#</span> (2)</span></pre></div>
<p dir="auto">There <code>images</code> attribute dictionary <code>(1)</code> defines the images available for the substitution. The manifest file references the fully qualified image target path <code>//examples:helloworld_image</code> <code>(2)</code>.</p>
<p dir="auto">The <code>image</code> key value in the dictionary is used as an image push identifier. The best practice (as provided in the example) is to use image key that matches the <a href="https://docs.bazel.build/versions/master/skylark/lib/Label.html#name" rel="nofollow">label name</a> of the image target.</p>
<p dir="auto">When we <code>bazel build</code> the example, the rendered manifest will look something like this:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: v1
kind: Pod
metadata:
  name: helloworld
spec:
  containers:
    - image: registry.example.com/examples/helloworld_image@sha256:c94d75d68f4c1b436f545729bbce82774fda07"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-c1">v1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">Pod</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">helloworld</span>
<span class="pl-ent">spec</span>:
  <span class="pl-ent">containers</span>:
    - <span class="pl-ent">image</span>: <span class="pl-s">registry.example.com/examples/helloworld_image@sha256:c94d75d68f4c1b436f545729bbce82774fda07</span></pre></div>
<p dir="auto">The image substitution using an <code>images</code> key is supported, but <em><strong>not recommended</strong></em> (this functionality might be removed in the future). For example, <code>helloworld.yaml</code> can reference <code>helloworld_image</code>:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: v1
kind: Pod
metadata:
  name: helloworld
spec:
  containers:
    - image: helloworld_image"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-c1">v1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">Pod</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">helloworld</span>
<span class="pl-ent">spec</span>:
  <span class="pl-ent">containers</span>:
    - <span class="pl-ent">image</span>: <span class="pl-s">helloworld_image</span></pre></div>
<p dir="auto">Image substitutions for Custom Resource Definitions (CRD) resources could also use target references directly. Their digests are available through string substitution. For example,</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: v1
kind: MyCrd
metadata:
  name: my_crd
  labels:
    app_label_image_digest: &quot;{{//examples:helloworld_image.digest}}&quot;
    app_label_image_short_digest: &quot;{{//examples:helloworld_image.short-digest}}&quot;
spec:
  image: &quot;{{//examples:helloworld_image}}&quot;"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-c1">v1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">MyCrd</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">my_crd</span>
  <span class="pl-ent">labels</span>:
    <span class="pl-ent">app_label_image_digest</span>: <span class="pl-s"><span class="pl-pds">"</span>{{//examples:helloworld_image.digest}}<span class="pl-pds">"</span></span>
    <span class="pl-ent">app_label_image_short_digest</span>: <span class="pl-s"><span class="pl-pds">"</span>{{//examples:helloworld_image.short-digest}}<span class="pl-pds">"</span></span>
<span class="pl-ent">spec</span>:
  <span class="pl-ent">image</span>: <span class="pl-s"><span class="pl-pds">"</span>{{//examples:helloworld_image}}<span class="pl-pds">"</span></span></pre></div>
<p dir="auto">would become</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="apiVersion: v1
kind: MyCrd
metadata:
  name: my_crd
  labels:
    app_label_image_digest: &quot;e6d465223da74519ba3e2b38179d1268b71a72f&quot;
    app_label_image_short_digest: &quot;e6d465223d&quot;
spec:
  image: registry.example.com/examples/helloworld_image@sha256:e6d465223da74519ba3e2b38179d1268b71a72f"><pre><span class="pl-ent">apiVersion</span>: <span class="pl-c1">v1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">MyCrd</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">my_crd</span>
  <span class="pl-ent">labels</span>:
    <span class="pl-ent">app_label_image_digest</span>: <span class="pl-s"><span class="pl-pds">"</span>e6d465223da74519ba3e2b38179d1268b71a72f<span class="pl-pds">"</span></span>
    <span class="pl-ent">app_label_image_short_digest</span>: <span class="pl-s"><span class="pl-pds">"</span>e6d465223d<span class="pl-pds">"</span></span>
<span class="pl-ent">spec</span>:
  <span class="pl-ent">image</span>: <span class="pl-s">registry.example.com/examples/helloworld_image@sha256:e6d465223da74519ba3e2b38179d1268b71a72f</span></pre></div>
<p dir="auto">An all examples above the <code>image:</code> URL points to the <code>helloworld_image</code> in the private Docker registry. The image is uploaded to the registry before any <code>.apply</code> or <code>.gitops</code> target is executed. See <a href="examples/helloworld/deployment.yaml">helloworld</a> for a complete example.</p>
<p dir="auto">As with the rest of the dependency graph, Bazel understands the dependencies <code>k8s_deploy</code> has on the
Docker image and the files in the image. So for example, here's what will happen if someone makes a change to one of the Java files in <code>helloworld_image</code> and then runs <code>bazel run //examples:helloworld.apply</code>:</p>
<ol dir="auto">
<li>The <code>helloworld_image</code> will be rebuilt with the new code and uploaded to the registry</li>
<li>A new <code>helloworld</code> manifest will be rendered using the new image</li>
<li>The new <code>helloworld</code> pod will be deployed</li>
</ol>
<p dir="auto">It is possible to use alternative ways to resolve images as long as respective rule implements K8sPushInfo provider. For example, this setup will mirror the referred image into a local registry and provide a reference to it. <code>k8s_deploy</code> will need to use <code>image_pushes</code> parameter:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@com_fasterci_rules_mirror//mirror:defs.bzl&quot;, &quot;mirror_image&quot;)
mirror_image(
    name = &quot;agnhost_image&quot;,
    digest = &quot;sha256:93c166faf53dba3c9c4227e2663ec1247e2a9a193d7b59eddd15244a3e331c3e&quot;,
    dst_prefix = &quot;gcr.io/myregistry/mirror&quot;,
    src_image = &quot;registry.k8s.io/e2e-test-images/agnhost:2.39&quot;,
)
k8s_deploy(
    name = &quot;agnhost&quot;,
    manifests = [&quot;agnhost.yaml&quot;],
    image_pushes = [
        &quot;:agnhost_image&quot;,
    ]
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@com_fasterci_rules_mirror//mirror:defs.bzl"</span>, <span class="pl-s">"mirror_image"</span>)
<span class="pl-en">mirror_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"agnhost_image"</span>,
    <span class="pl-s1">digest</span> <span class="pl-c1">=</span> <span class="pl-s">"sha256:93c166faf53dba3c9c4227e2663ec1247e2a9a193d7b59eddd15244a3e331c3e"</span>,
    <span class="pl-s1">dst_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"gcr.io/myregistry/mirror"</span>,
    <span class="pl-s1">src_image</span> <span class="pl-c1">=</span> <span class="pl-s">"registry.k8s.io/e2e-test-images/agnhost:2.39"</span>,
)
<span class="pl-en">k8s_deploy</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"agnhost"</span>,
    <span class="pl-s1">manifests</span> <span class="pl-c1">=</span> [<span class="pl-s">"agnhost.yaml"</span>],
    <span class="pl-s1">image_pushes</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":agnhost_image"</span>,
    ]
)</pre></div>
<p dir="auto"><a name="user-content-adding-dependencies"></a></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Adding Dependencies</h3><a id="user-content-adding-dependencies" class="anchor" aria-label="Permalink: Adding Dependencies" href="#adding-dependencies"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Many instances of <code>k8s_deploy</code> include an <code>objects</code> attribute that references other instances of
<code>k8s_deploy</code>. When chained this way, running the <code>.apply</code> will also apply any dependencies as well.</p>
<p dir="auto">For example, to add dependency to the example <a href="./examples/helloworld/BUILD">helloworld deployment</a>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="k8s_deploy(
    name = &quot;mynamespace&quot;,
    objects = [
        &quot;//other:mynamespace&quot;,
    ],
    ...
)"><pre><span class="pl-en">k8s_deploy</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"mynamespace"</span>,
    <span class="pl-s1">objects</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"//other:mynamespace"</span>,
    ],
    ...
)</pre></div>
<p dir="auto">When you run <code>bazel run //helloworld:mynamespace.apply</code>, it'll deploy a <em>helloword</em> and <em>other</em>  service instance into your namespace.</p>
<p dir="auto">Please note that the <code>objects</code> attribute is ignored by <code>.gitops</code> targets.</p>
<p dir="auto"><a name="user-content-gitops-and-deployment"></a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">GitOps and Deployment</h2><a id="user-content-gitops-and-deployment" class="anchor" aria-label="Permalink: GitOps and Deployment" href="#gitops-and-deployment"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The simplified CI pipeline that incorporates GitOps will look like this:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="[Checkout Code] -&gt; [Bazel Build &amp; Test] -&gt; (if GitOps source branch) -&gt; [Create GitOps PRs]"><pre class="notranslate"><code>[Checkout Code] -&gt; [Bazel Build &amp; Test] -&gt; (if GitOps source branch) -&gt; [Create GitOps PRs]
</code></pre></div>
<p dir="auto">The <em>Create GitOps PRs</em> step usually is the last step of a CI pipeline. <code>rules_gitops</code> provides the <code>create_gitops_prs</code> command line tool that automates the process of creating pull requests.</p>
<p dir="auto">For the full list of <code>create_gitops_prs</code> command line options, run:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel run @com_adobe_rules_gitops//gitops/prer:create_gitops_prs"><pre>bazel run @com_adobe_rules_gitops//gitops/prer:create_gitops_prs</pre></div>
<p dir="auto"><a name="user-content-gitops-and-deployment-supported-git-servers"></a></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Supported Git Servers</h3><a id="user-content-supported-git-servers" class="anchor" aria-label="Permalink: Supported Git Servers" href="#supported-git-servers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>--git_server</code> parameter defines the type of a Git server API to use. The supported Git server types are <code>github</code>, <code>gitlab</code>, and <code>bitbucket</code>.</p>
<p dir="auto">Depending on the Git server type the <code>create_gitops_prs</code> tool will use following command line parameters:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>--git_server</th>
<th>Parameter</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>github</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><em><strong>--github_repo_owner</strong></em></td>
<td>``</td>
</tr>
<tr>
<td></td>
<td><em><strong>--github_repo</strong></em></td>
<td>``</td>
</tr>
<tr>
<td></td>
<td><em><strong>--github_access_token</strong></em></td>
<td><code>$GITHUB_TOKEN</code></td>
</tr>
<tr>
<td></td>
<td><em><strong>--github_enterprise_host</strong></em></td>
<td>``</td>
</tr>
<tr>
<td><code>gitlab</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><em><strong>--gitlab_host</strong></em></td>
<td><code>https://gitlab.com</code></td>
</tr>
<tr>
<td></td>
<td><em><strong>--gitlab_repo</strong></em></td>
<td>``</td>
</tr>
<tr>
<td></td>
<td><em><strong>--gitlab_access_token</strong></em></td>
<td><code>$GITLAB_TOKEN</code></td>
</tr>
<tr>
<td><code>bitbucket</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><em><strong>--bitbucket_api_pr_endpoint</strong></em></td>
<td>``</td>
</tr>
<tr>
<td></td>
<td><em><strong>--bitbucket_user</strong></em></td>
<td><code>$BITBUCKET_USER</code></td>
</tr>
<tr>
<td></td>
<td><em><strong>--bitbucket_password</strong></em></td>
<td><code>$BITBUCKET_PASSWORD</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><a name="user-content-trunk-based-gitops-workflow"></a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Trunk Based GitOps Workflow</h2><a id="user-content-trunk-based-gitops-workflow" class="anchor" aria-label="Permalink: Trunk Based GitOps Workflow" href="#trunk-based-gitops-workflow"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">For example let's assume the CI build pipeline described above is running the build for <code>https://github.com/example/repo.git</code>. We are using trunk based branching model. All feature branches are merged into the <code>master</code> branch first. The <em>Create GitOps PRs</em> step runs on a <code>master</code> branch change. The GitOps deployments source files are located in the same repository under the <code>/cloud</code> directory.</p>
<p dir="auto">The <em>Create GitOps PRs</em> pipeline step shell command will look like following:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="GIT_ROOT_DIR=$(git rev-parse --show-toplevel)
GIT_COMMIT_ID=$(git rev-parse HEAD)
GIT_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
if [ &quot;${GIT_BRANCH_NAME}&quot; == &quot;master&quot;]; then
    bazel run @com_adobe_rules_gitops//gitops/prer:create_gitops_prs -- \
        --workspace $GIT_ROOT_DIR \
        --git_repo https://github.com/example/repo.git \
        --git_mirror $GIT_ROOT_DIR/.git \
        --git_server github \
        --release_branch master \
        --gitops_pr_into master \
        --gitops_pr_title &quot;This is my pull request title&quot; \
        --gitops_pr_body &quot;This is my pull request body message&quot; \
        --branch_name ${GIT_BRANCH_NAME} \
        --git_commit ${GIT_COMMIT_ID} \
fi"><pre>GIT_ROOT_DIR=<span class="pl-s"><span class="pl-pds">$(</span>git rev-parse --show-toplevel<span class="pl-pds">)</span></span>
GIT_COMMIT_ID=<span class="pl-s"><span class="pl-pds">$(</span>git rev-parse HEAD<span class="pl-pds">)</span></span>
GIT_BRANCH_NAME=<span class="pl-s"><span class="pl-pds">$(</span>git rev-parse --abbrev-ref HEAD<span class="pl-pds">)</span></span>
<span class="pl-k">if</span> [ <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">${GIT_BRANCH_NAME}</span><span class="pl-pds">"</span></span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>master<span class="pl-pds">"</span></span>]<span class="pl-k">;</span> <span class="pl-k">then</span>
    bazel run @com_adobe_rules_gitops//gitops/prer:create_gitops_prs -- \
        --workspace <span class="pl-smi">$GIT_ROOT_DIR</span> \
        --git_repo https://github.com/example/repo.git \
        --git_mirror <span class="pl-smi">$GIT_ROOT_DIR</span>/.git \
        --git_server github \
        --release_branch master \
        --gitops_pr_into master \
        --gitops_pr_title <span class="pl-s"><span class="pl-pds">"</span>This is my pull request title<span class="pl-pds">"</span></span> \
        --gitops_pr_body <span class="pl-s"><span class="pl-pds">"</span>This is my pull request body message<span class="pl-pds">"</span></span> \
        --branch_name <span class="pl-smi">${GIT_BRANCH_NAME}</span> \
        --git_commit <span class="pl-smi">${GIT_COMMIT_ID}</span> \
<span class="pl-k">fi</span></pre></div>
<p dir="auto">The <code>GIT_*</code> variables describe the current state of the Git repository.</p>
<p dir="auto">The <code>--git_repo</code> parameter defines the remote repository URL. In this case remote repository matches the repository of the working copy. The <code>--git_mirror</code> parameter is an optimization used to speed up the target repository clone process using reference repository (see <code>git clone --reference</code>). The <code>--git-server</code> parameter selects the type of Git server.</p>
<p dir="auto">The <code>--release_branch</code> specifies the value of the <em><strong>release_branch_prefix</strong></em> attribute of <code>gitops</code> targets (see <a href="#k8s_deploy">k8s_deploy</a>). The <code>--gitops_pr_into</code> defines the target branch for newly created pull requests. The <code>--branch_name</code> and <code>--git_commit</code> are the values used in the pull request commit message.</p>
<p dir="auto">The <code>create_gitops_prs</code> tool will query all <code>gitops</code> targets which have set the <em><strong>deploy_branch</strong></em> attribute (see <a href="#k8s_deploy">k8s_deploy</a>) and the <em><strong>release_branch_prefix</strong></em> attribute value that matches the <code>release_branch</code> parameter.</p>
<p dir="auto">The all discovered <code>gitops</code> targets are grouped by the value of <em><strong>deploy_branch</strong></em> attribute. The one deployment branch will accumulate the output of all corresponding <code>gitops</code> targets.</p>
<p dir="auto">For example, we define two deployments: grafana and prometheus. Both deployments share the same namespace. The deployments a grouped by namespace.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="[
    k8s_deploy(
        name = NAME,
        deploy_branch = NAMESPACE,
        ...
    )
    for NAME, CLUSTER, NAMESPACE in [
        ...
        (&quot;stage-grafana&quot;, &quot;stage&quot;, &quot;monitoring-stage&quot;),
        (&quot;prod-grafana&quot;, &quot;prod&quot;, &quot;monitoring-prod&quot;),
    ]
]
[
    k8s_deploy(
        name = NAME,
        deploy_branch = NAMESPACE,
        ...
    )
    for NAME, CLUSTER, NAMESPACE in [
        ...
        (&quot;stage-prometheus&quot;, &quot;stage&quot;, &quot;monitoring-stage&quot;),
        (&quot;prod-prometheus&quot;, &quot;prod&quot;, &quot;monitoring-prod&quot;),
    ]
]"><pre>[
    <span class="pl-en">k8s_deploy</span>(
        <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-c1">NAME</span>,
        <span class="pl-s1">deploy_branch</span> <span class="pl-c1">=</span> <span class="pl-c1">NAMESPACE</span>,
        ...
    )
    <span class="pl-k">for</span> <span class="pl-c1">NAME</span>, <span class="pl-c1">CLUSTER</span>, <span class="pl-c1">NAMESPACE</span> <span class="pl-c1">in</span> [
        ...
        (<span class="pl-s">"stage-grafana"</span>, <span class="pl-s">"stage"</span>, <span class="pl-s">"monitoring-stage"</span>),
        (<span class="pl-s">"prod-grafana"</span>, <span class="pl-s">"prod"</span>, <span class="pl-s">"monitoring-prod"</span>),
    ]
]
[
    <span class="pl-en">k8s_deploy</span>(
        <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-c1">NAME</span>,
        <span class="pl-s1">deploy_branch</span> <span class="pl-c1">=</span> <span class="pl-c1">NAMESPACE</span>,
        ...
    )
    <span class="pl-k">for</span> <span class="pl-c1">NAME</span>, <span class="pl-c1">CLUSTER</span>, <span class="pl-c1">NAMESPACE</span> <span class="pl-c1">in</span> [
        ...
        (<span class="pl-s">"stage-prometheus"</span>, <span class="pl-s">"stage"</span>, <span class="pl-s">"monitoring-stage"</span>),
        (<span class="pl-s">"prod-prometheus"</span>, <span class="pl-s">"prod"</span>, <span class="pl-s">"monitoring-prod"</span>),
    ]
]</pre></div>
<p dir="auto">As a result of the setup above the <code>create_gitops_prs</code> tool will open up to 2 potential deployment pull requests:</p>
<ul dir="auto">
<li>from <code>deploy/monitoring-stage</code> to <code>master</code> including manifests for <code>stage-grafana</code> and <code>stage-prometheus</code></li>
<li>from <code>deploy/monitoring-prod</code> to <code>master</code> including manifests for <code>prod-grafana</code> and <code>prod-prometheus</code></li>
</ul>
<p dir="auto">The GitOps pull request is only created (or new commits added) if the <code>gitops</code> target changes the state for the target deployment branch. The source pull request will remain open (and keep accumulation GitOps results) until the pull request is merged and source branch is deleted.</p>
<p dir="auto">The <code>--stamp</code> parameter allows for the replacement of certain placeholders, but only when the <code>gitops</code> target changes the output's digest compared to the one already saved. The new digest of the unstamped data is also saved with the manifest. The digest is kept in a file in the same location as the YAML file, with a <code>.digest</code> extension added to its name. This is helpful when the manifests have volatile information that shouldn't be the only factor causing changes in the target deployment branch.</p>
<p dir="auto">Here are the placeholders that can be replaced:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Placeholder</th>
<th>Replacement</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{{GIT_REVISION}}</code></td>
<td>Result of <code>git rev-parse HEAD</code></td>
</tr>
<tr>
<td><code>{{UTC_DATE}}</code></td>
<td>Result of <code>date -u</code></td>
</tr>
<tr>
<td><code>{{GIT_BRANCH}}</code></td>
<td>The <code>branch_name</code> argument given to <code>create_gitops_prs</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><code>--dry_run</code> parameter can be used to test the tool without creating any pull requests. The tool will print the list of the potential pull requests. It is recommended to run the tool in the dry run mode as a part of the CI test suite to verify that the tool is configured correctly.</p>
<p dir="auto"><a name="user-content-multiple-release-branches-gitops-workflow"></a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Multiple Release Branches GitOps Workflow</h2><a id="user-content-multiple-release-branches-gitops-workflow" class="anchor" aria-label="Permalink: Multiple Release Branches GitOps Workflow" href="#multiple-release-branches-gitops-workflow"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In the situation when the trunk based branching model in not suitable the <code>create_gitops_prs</code> tool supports creating GitOps pull requests before the code is merged to <code>master</code> branch.</p>
<p dir="auto">Both trunk and release branch workflow could coexists in the same repository.</p>
<p dir="auto">For example, let's assume the CI build pipeline described above is running the build for <code>https://github.com/example/repo.git</code>. We are using release branch branching model. Feature request are merged into multiple target release branches. The release brach name convention is <code>release/team-&lt;YYYYMMDD&gt;</code>. The <em>Create GitOps PRs</em> step is running on the release branch change. GitOps deployments source files are located in the same repository <code>/cloud</code> directory in the <code>master</code> branch.</p>
<p dir="auto">The <em>Create GitOps PRs</em> pipeline step shell command will look like following:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="GIT_ROOT_DIR=$(git rev-parse --show-toplevel)
GIT_COMMIT_ID=$(git rev-parse HEAD)
GIT_BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)          # =&gt; release/team-20200101
RELEASE_BRANCH_SUFFIX=${GIT_BRANCH_NAME#&quot;release/team&quot;}     # =&gt; -20200101
RELEASE_BRANCH=${GIT_BRANCH_NAME%${RELEASE_BRANCH_SUFFIX}}  # =&gt; release/team
if [ &quot;${RELEASE_BRANCH}&quot; == &quot;release/team&quot;]; then
    bazel run @com_adobe_rules_gitops//gitops/prer:create_gitops_prs -- \
        --workspace $GIT_ROOT_DIR \
        --git_repo https://github.com/example/repo.git \
        --git_mirror $GIT_ROOT_DIR/.git \
        --git_server github \
        --release_branch ${RELEASE_BRANCH} \
        --deployment_branch_suffix=${RELEASE_BRANCH_SUFFIX} \
        --gitops_pr_into master \
        --gitops_pr_title &quot;This is my pull request title&quot; \
        --gitops_pr_body &quot;This is my pull request body message&quot; \
        --branch_name ${GIT_BRANCH_NAME} \
        --git_commit ${GIT_COMMIT_ID} \
fi"><pre>GIT_ROOT_DIR=<span class="pl-s"><span class="pl-pds">$(</span>git rev-parse --show-toplevel<span class="pl-pds">)</span></span>
GIT_COMMIT_ID=<span class="pl-s"><span class="pl-pds">$(</span>git rev-parse HEAD<span class="pl-pds">)</span></span>
GIT_BRANCH_NAME=<span class="pl-s"><span class="pl-pds">$(</span>git rev-parse --abbrev-ref HEAD<span class="pl-pds">)</span></span>          <span class="pl-c"><span class="pl-c">#</span> =&gt; release/team-20200101</span>
RELEASE_BRANCH_SUFFIX=<span class="pl-smi">${GIT_BRANCH_NAME<span class="pl-k">#</span><span class="pl-s"><span class="pl-pds">"</span>release/team<span class="pl-pds">"</span></span>}</span>     <span class="pl-c"><span class="pl-c">#</span> =&gt; -20200101</span>
RELEASE_BRANCH=<span class="pl-smi">${GIT_BRANCH_NAME<span class="pl-k">%</span><span class="pl-smi">${RELEASE_BRANCH_SUFFIX}</span>}</span>  <span class="pl-c"><span class="pl-c">#</span> =&gt; release/team</span>
<span class="pl-k">if</span> [ <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">${RELEASE_BRANCH}</span><span class="pl-pds">"</span></span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>release/team<span class="pl-pds">"</span></span>]<span class="pl-k">;</span> <span class="pl-k">then</span>
    bazel run @com_adobe_rules_gitops//gitops/prer:create_gitops_prs -- \
        --workspace <span class="pl-smi">$GIT_ROOT_DIR</span> \
        --git_repo https://github.com/example/repo.git \
        --git_mirror <span class="pl-smi">$GIT_ROOT_DIR</span>/.git \
        --git_server github \
        --release_branch <span class="pl-smi">${RELEASE_BRANCH}</span> \
        --deployment_branch_suffix=<span class="pl-smi">${RELEASE_BRANCH_SUFFIX}</span> \
        --gitops_pr_into master \
        --gitops_pr_title <span class="pl-s"><span class="pl-pds">"</span>This is my pull request title<span class="pl-pds">"</span></span> \
        --gitops_pr_body <span class="pl-s"><span class="pl-pds">"</span>This is my pull request body message<span class="pl-pds">"</span></span> \
        --branch_name <span class="pl-smi">${GIT_BRANCH_NAME}</span> \
        --git_commit <span class="pl-smi">${GIT_COMMIT_ID}</span> \
<span class="pl-k">fi</span></pre></div>
<p dir="auto">The meaning of the parameters is the same as with <a href="#trunk_based_gitops_workflow">trunk based workflow</a>.
The <code>--release_branch</code> parameter takes the value of <code>release/team</code>. The additional parameter <code>--deployment_branch_suffix</code> will add the release branch suffix to the target deployment branch name.</p>
<p dir="auto">If we modify previous example:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="[
    k8s_deploy(
        name = NAME,
        deploy_branch = NAMESPACE,
        release_branch_prefix = &quot;release/team&quot;,  # will be selected only when --release_branch=release/team
        ...
    )
    for NAME, CLUSTER, NAMESPACE in [
        ...
        (&quot;stage-grafana&quot;, &quot;stage&quot;, &quot;monitoring-stage&quot;),
        (&quot;prod-grafana&quot;, &quot;prod&quot;, &quot;monitoring-prod&quot;),
    ]
]
[
    k8s_deploy(
        name = NAME,
        deploy_branch = NAMESPACE,
        release_branch_prefix = &quot;release/team&quot;,  # will be selected only when --release_branch=release/team
        ...
    )
    for NAME, CLUSTER, NAMESPACE in [
        ...
        (&quot;stage-prometheus&quot;, &quot;stage&quot;, &quot;monitoring-stage&quot;),
        (&quot;prod-prometheus&quot;, &quot;prod&quot;, &quot;monitoring-prod&quot;),
    ]
]"><pre>[
    <span class="pl-en">k8s_deploy</span>(
        <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-c1">NAME</span>,
        <span class="pl-s1">deploy_branch</span> <span class="pl-c1">=</span> <span class="pl-c1">NAMESPACE</span>,
        <span class="pl-s1">release_branch_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"release/team"</span>,  <span class="pl-c"># will be selected only when --release_branch=release/team</span>
        ...
    )
    <span class="pl-k">for</span> <span class="pl-c1">NAME</span>, <span class="pl-c1">CLUSTER</span>, <span class="pl-c1">NAMESPACE</span> <span class="pl-c1">in</span> [
        ...
        (<span class="pl-s">"stage-grafana"</span>, <span class="pl-s">"stage"</span>, <span class="pl-s">"monitoring-stage"</span>),
        (<span class="pl-s">"prod-grafana"</span>, <span class="pl-s">"prod"</span>, <span class="pl-s">"monitoring-prod"</span>),
    ]
]
[
    <span class="pl-en">k8s_deploy</span>(
        <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-c1">NAME</span>,
        <span class="pl-s1">deploy_branch</span> <span class="pl-c1">=</span> <span class="pl-c1">NAMESPACE</span>,
        <span class="pl-s1">release_branch_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"release/team"</span>,  <span class="pl-c"># will be selected only when --release_branch=release/team</span>
        ...
    )
    <span class="pl-k">for</span> <span class="pl-c1">NAME</span>, <span class="pl-c1">CLUSTER</span>, <span class="pl-c1">NAMESPACE</span> <span class="pl-c1">in</span> [
        ...
        (<span class="pl-s">"stage-prometheus"</span>, <span class="pl-s">"stage"</span>, <span class="pl-s">"monitoring-stage"</span>),
        (<span class="pl-s">"prod-prometheus"</span>, <span class="pl-s">"prod"</span>, <span class="pl-s">"monitoring-prod"</span>),
    ]
]</pre></div>
<p dir="auto">The result of the setup above the <code>create_gitops_prs</code> tool will open up to 2 potential deployment pull requests per release branch. Assuming release branch name is <code>release/team-20200101</code>:</p>
<ul dir="auto">
<li>from <code>deploy/monitoring-stage-20200101</code> to <code>master</code> including manifests for <code>stage-grafana</code> and <code>stage-prometheus</code></li>
<li>from <code>deploy/monitoring-prod-20200101</code> to <code>master</code> including manifests for <code>prod-grafana</code> and <code>prod-prometheus</code></li>
</ul>
<p dir="auto"><a name="user-content-integration-testing-support"></a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Integration Testing Support</h2><a id="user-content-integration-testing-support" class="anchor" aria-label="Permalink: Integration Testing Support" href="#integration-testing-support"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>Note:</strong> the Integration testing support has known limitations and should be considered <strong>experimental</strong>. The public API is subject to change.</p>
<p dir="auto">Integration tests are defined in <code>BUILD</code> files like this:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="k8s_test_setup(
    name = &quot;service_it.setup&quot;,
    kubeconfig = &quot;@k8s_test//:kubeconfig&quot;,
    objects = [
        &quot;//service:mynamespace&quot;,
    ],
)

java_test(
    name = &quot;service_it&quot;,
    srcs = [
        &quot;ServiceIT.java&quot;,
    ],
    data = [
        &quot;:service_it.setup&quot;,
    ],
    jvm_flags = [
        &quot;-Dk8s.setup=$(location :service_it.setup)&quot;,
    ],
    # other attributes omitted for brevity
)"><pre><span class="pl-en">k8s_test_setup</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"service_it.setup"</span>,
    <span class="pl-s1">kubeconfig</span> <span class="pl-c1">=</span> <span class="pl-s">"@k8s_test//:kubeconfig"</span>,
    <span class="pl-s1">objects</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"//service:mynamespace"</span>,
    ],
)

<span class="pl-en">java_test</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"service_it"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"ServiceIT.java"</span>,
    ],
    <span class="pl-s1">data</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":service_it.setup"</span>,
    ],
    <span class="pl-s1">jvm_flags</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"-Dk8s.setup=$(location :service_it.setup)"</span>,
    ],
    <span class="pl-c"># other attributes omitted for brevity</span>
)</pre></div>
<p dir="auto">The test is composed of two rules, a <code>k8s_test_setup</code> rule to manage the Kubernetes setup and a <code>java_test</code> rule that executes the actual test.</p>
<p dir="auto">The <code>k8s_test_setup</code> rule produces a shell script which creates a temporary namespace (the namespace name is your username followed by five random digits) and creates a kubeconfig file that allows access to this new namespace. Inside the namespace, it creates some objects specified in the <code>objects</code> attributes. In the example, there is one target here: <code>//service:mynamespace</code>. This target represents a file containing all the Kubernetes object manifests required to run the service.</p>
<p dir="auto">The output of the <code>k8s_test_setup</code> rule (a shell script) is referenced in the <code>java_test</code> rule. It's listed under the <code>data</code> attribute, which declares the target as a dependency, and is included in the jvm flags in this clause: <code>$(location :service_it.setup)</code>. The "location" function is specific to Bazel: given a target, it returns the path to the file produced by that target. In this case, it returns the path to the shell script created by our <code>k8s_test_setup</code> rule.</p>
<p dir="auto">The test code launches the script to perform the test setup. The test code should also monitor the script console output to listen to the pod readiness events.</p>
<p dir="auto">The <code>@k8s_test//:kubeconfig</code> target referenced from <code>k8s_test_setup</code> rule serves the purpose of making Kubernetes configuration available in the test sandbox. The <code>kubeconfig</code> repository rule in the <code>WORKSPACE</code> file will need, at minimum, provide the cluster name.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@com_adobe_rules_gitops//gitops:defs.bzl&quot;, &quot;kubeconfig&quot;)

kubeconfig(
    name = &quot;k8s_test&quot;,
    cluster = &quot;dev&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@com_adobe_rules_gitops//gitops:defs.bzl"</span>, <span class="pl-s">"kubeconfig"</span>)

<span class="pl-en">kubeconfig</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"k8s_test"</span>,
    <span class="pl-s1">cluster</span> <span class="pl-c1">=</span> <span class="pl-s">"dev"</span>,
)</pre></div>
<p dir="auto"><a name="user-content-k8s_test_setup"></a></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">k8s_test_setup</h3><a id="user-content-k8s_test_setup" class="anchor" aria-label="Permalink: k8s_test_setup" href="#k8s_test_setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>Note:</strong> the <code>k8s_test_setup</code> rule is an <strong>experimental</strong> feature and is subject to change.</p>
<p dir="auto">An executable that performs Kubernetes test setup:</p>
<ul dir="auto">
<li>creates temporary namespace</li>
<li>creates kubectl configuration with the default context set to the created namespace</li>
<li>deploys all dependent <em><strong>objects</strong></em></li>
<li>forwards service ports</li>
</ul>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em><strong>kubeconfig</strong></em></td>
<td><code>@k8s_test//:kubeconfig</code></td>
<td>The Kubernetes configuration file target.</td>
</tr>
<tr>
<td><em><strong>kubectl</strong></em></td>
<td><code>@k8s_test//:kubectl</code></td>
<td>The Kubectl executable target.</td>
</tr>
<tr>
<td><em><strong>objects</strong></em></td>
<td><code>None</code></td>
<td>A list of other instances of <code>k8s_deploy</code> that test depends on. See <a href="#adding-dependencies">Adding Dependencies</a></td>
</tr>
<tr>
<td><em><strong>setup_timeout</strong></em></td>
<td><code>10m</code></td>
<td>The time to wait until all required services become ready. The timeout duration should be lower that Bazel test timeout.</td>
</tr>
<tr>
<td><em><strong>portforward_services</strong></em></td>
<td><code>None</code></td>
<td>The list of Kubernetes service names to port forward. The setup will wait for at least one service endpoint to become ready.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><a name="user-content-kubeconfig"></a></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">kubeconfig</h3><a id="user-content-kubeconfig" class="anchor" aria-label="Permalink: kubeconfig" href="#kubeconfig"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>Note:</strong> the <code>kubeconfig</code> repository rule is an <strong>experimental</strong> feature and is subject to change.</p>
<p dir="auto">Configures Kubernetes tools for testing.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em><strong>cluster</strong></em></td>
<td><code>None</code></td>
<td>The Kubernetes cluster name as defined in the host <code>kubectl</code> configuration.</td>
</tr>
<tr>
<td><em><strong>server</strong></em></td>
<td><code>None</code></td>
<td>Optional Kubernetes server endpoint to override automatically detected server endpoint. By default, the server endpoint is automatically detected based on the environment. When running inside the Kubernetes cluster (the service account is present), the server endpoint is derived from <code>KUBERNETES_SERVICE_HOST</code> and <code>KUBERNETES_SERVICE_PORT</code> environment variables. If environment variable are nto defined the server name is set to <code>https://kubernetes.default</code>. Otherwise the host <code>kubectl</code> configuration file is used.</td>
</tr>
<tr>
<td><em><strong>user</strong></em></td>
<td><code>None</code></td>
<td>Optional Kubernetes configuration user name. Default value is the current build user.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Building &amp; Testing</h2><a id="user-content-building--testing" class="anchor" aria-label="Permalink: Building &amp; Testing" href="#building--testing"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Building &amp; Testing GitOps Rules</h3><a id="user-content-building--testing-gitops-rules" class="anchor" aria-label="Permalink: Building &amp; Testing GitOps Rules" href="#building--testing-gitops-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel test //..."><pre>bazel <span class="pl-c1">test</span> //...</pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Building &amp; Testing Examples Project</h3><a id="user-content-building--testing-examples-project" class="anchor" aria-label="Permalink: Building &amp; Testing Examples Project" href="#building--testing-examples-project"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cd examples
bazel test //..."><pre><span class="pl-c1">cd</span> examples
bazel <span class="pl-c1">test</span> //...</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Have a Question</h2><a id="user-content-have-a-question" class="anchor" aria-label="Permalink: Have a Question" href="#have-a-question"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Find the <code>rules_gitops</code> contributors in the <a href="https://bazelbuild.slack.com/archives/C01SF68MTFS" rel="nofollow">#gitops</a> channel on the <a href="https://slack.bazel.build/" rel="nofollow">Bazel Slack</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Contributing</h2><a id="user-content-contributing" class="anchor" aria-label="Permalink: Contributing" href="#contributing"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Contributions are welcomed! Read the <a href="./.github/CONTRIBUTING.md">Contributing Guide</a> for more information.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Adopters</h2><a id="user-content-adopters" class="anchor" aria-label="Permalink: Adopters" href="#adopters"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Here's a (non-exhaustive) list of companies that use <code>rules_gitops</code> in production. Don't see yours? <a href="https://github.com/adobe/rules_gitops/edit/master/README.md">You can add it in a PR!</a></p>
<ul dir="auto">
<li><a href="https://www.adobe.com/advertising/adobe-advertising-cloud.html" rel="nofollow">Adobe (Advertising Cloud)</a></li>
<li><a href="https://fasterci.com" rel="nofollow">FasterCI</a></li>
<li><a href="https://www.skydio.com" rel="nofollow">Skydio</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Licensing</h2><a id="user-content-licensing" class="anchor" aria-label="Permalink: Licensing" href="#licensing"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The contents of third party dependencies in <a href="./vendor">/vendor</a> folder are covered by their repositories' respective licenses.</p>
<p dir="auto">The contents of <a href="./templating/fasttemplate">/templating/fasttemplate</a> are licensed under MIT License. See <a href="./templating/fasttemplate/LICENSE">LICENSE</a> for more information.</p>
<p dir="auto">All other files are licensed under the Apache V2 License. See <a href="LICENSE">LICENSE</a> for more information.</p>
</article></div>